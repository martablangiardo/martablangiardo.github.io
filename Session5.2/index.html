<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Session 5.2: Missing data inputation</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <script src="libs/kePrint/kePrint.js"></script>
    <link href="libs/lightable/lightable.css" rel="stylesheet" />
    <!-- (Re)Defines a bunch of LaTeX commands that can then be used directly in the .Rmd file as '\command{...}' -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: {
        /* This enables color macros */
        extensions: ["color.js"],
        Macros: {
          /* Probability & mathematical symbols */
          Pr: "{\\style{font-family:inherit; font-size: 110%;}{\\text{Pr}}}",
          exp: "{\\style{font-family:inherit; font-size: 105%;}{\\text{exp}}}",
          log: "{\\style{font-family:inherit; font-size: 105%;}{\\text{log}}}",
          ln: "{\\style{font-family:inherit; font-size: 105%;}{\\text{ln}}}",
          logit: "{\\style{font-family:inherit; font-size: 100%;}{\\text{logit}}}",
          HR: "{\\style{font-family:inherit; font-size: 105%;}{\\text{HR}}}",
          OR: "{\\style{font-family:inherit; font-size: 105%;}{\\text{OR}}}",
          E: "{\\style{font-family:inherit; font-size: 105%;}{\\text{E}}}",
          Var: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Var}}}",
          Cov: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Cov}}}",
          Corr: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Corr}}}",
          DIC: "{\\style{font-family:inherit; font-size: 105%;}{\\text{DIC}}}",
          se: "{\\style{font-family:inherit; font-size: 100%;}{\\text{se}}}",
          sd: "{\\style{font-family:inherit; font-size: 100%;}{\\text{sd}}}",
          kld: "{\\style{font-family:inherit; font-size: 100%;}{\\text{kld}}}",
          /* Distributions */
          dnorm: "{\\style{font-family:inherit;}{\\text{Normal}}}",
          dt: "{\\style{font-family:inherit;}{\\text{t}}}",
          ddirch: "{\\style{font-family:inherit;}{\\text{Dirichlet}}}",
          dmulti: "{\\style{font-family:inherit;}{\\text{Multinomial}}}",
          dbeta: "{\\style{font-family:inherit;}{\\text{Beta}}}",
          dgamma: "{\\style{font-family:inherit;}{\\text{Gamma}}}",
          dbern: "{\\style{font-family:inherit;}{\\text{Bernoulli}}}",
          dbin: "{\\style{font-family:inherit;}{\\text{Binomial}}}",
          dpois: "{\\style{font-family:inherit;}{\\text{Poisson}}}",
          dweib: "{\\style{font-family:inherit;}{\\text{Weibull}}}",
          dexp: "{\\style{font-family:inherit;}{\\text{Exponential}}}",
          dlnorm: "{\\style{font-family:inherit;}{\\text{logNormal}}}",
          dunif: "{\\style{font-family:inherit;}{\\text{Uniform}}}",
          /* LaTeX formatting */
          bm: ["{\\boldsymbol #1}",1],
          /* These create macros to typeset numbers in maths with the basic font */
          0: "{\\style{font-family:inherit; font-size: 105%;}{\\text{0}}}",
          1: "{\\style{font-family:inherit; font-size: 105%;}{\\text{1}}}",
          2: "{\\style{font-family:inherit; font-size: 105%;}{\\text{2}}}",
          3: "{\\style{font-family:inherit; font-size: 105%;}{\\text{3}}}",
          4: "{\\style{font-family:inherit; font-size: 105%;}{\\text{4}}}",
          5: "{\\style{font-family:inherit; font-size: 105%;}{\\text{5}}}",
          6: "{\\style{font-family:inherit; font-size: 105%;}{\\text{6}}}",
          7: "{\\style{font-family:inherit; font-size: 105%;}{\\text{7}}}",
          8: "{\\style{font-family:inherit; font-size: 105%;}{\\text{8}}}",
          9: "{\\style{font-family:inherit; font-size: 105%;}{\\text{9}}}",
          /* Health economics quantities */
          icer: "{\\style{font-family:inherit; font-size: 100%;}{\\text{ICER}}}",
          nb: "{\\style{font-family:inherit; font-size: 100%;}{\\text{NB}}}",
          ol: "{\\style{font-family:inherit; font-size: 100%;}{\\text{OL}}}",
          ceac: "{\\style{font-family:inherit; font-size: 100%;}{\\text{CEAC}}}",
          evpi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVPI}}}",
          evppi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVPPI}}}",
          evsi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVSI}}}"
        }
      }
    });
    </script>
    <link rel="stylesheet" href="assets/beamer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">






class: title-slide

# Session 5.2: Missing data inputation&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt; 

## 

###     

### Imperial College London

&lt;!-- Can also separate the various components of the extra argument 'params', eg as in 
### Imperial College London, , MSc in Epidemiology / Health Data Analytics
--&gt;



---

layout: true  

.my-footer[ 
.alignleft[ 
&amp;nbsp; &amp;copy; Marta Blangiardo | Monica Pirani 
]
.aligncenter[
MSc in Epidemiology / Health Data Analytics 
]
.alignright[
Imperial College London, NA 
]
] 


---

# Learning Objectives

After this session you should be able to:

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Appreciate the importance of thinking about why data are
missing, and stating your modelling assumptions

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Understand the disadvantages of complete case analysis

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Learn about how Bayesian methods can be used as  ‘statistically principled’ for handling missing data

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Be able to run the above models in R-INLA

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;


The topics covered in this lecture are covered in Chapter 12 of Gómez-Rubio (2020a).

---

# Why we care about missing data

- Missing data are common!

- Usually inadequately handled in both observational and
experimental research

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- For example,  reviewed 71 recently published BMJ, JAMA, Lancet and NEJM papers

  - 89% had partly missing outcome data
  
  - In 37 trials with repeated outcome measures, 46% performed complete case analysis
  
  - Only 21% reported sensitivity analysis

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

-  reviewed articles using Multiple Imputation in BMJ, JAMA, Lancet and NEJM from 2002 to 2007

  - 59 articles found, with use doubling over 6 year period
  
  - However, the reporting was almost always inadequate

---

# Outline 

1\. [How do missing data arise?](#how)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

2\. [Example: children height and weight](#example)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

3\. [Bayesian imputation](#model)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

4\. [Extending the model](#extending)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

---

name: how

&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**How do missing data arise?**]]]


---

# How do missing data arise?

&lt;center&gt;&lt;img src=./img/Missing_DAG.png width='80%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;

---

# Different types of missing data: MCAR

- There are three types of missing data, depending on why the missingness arise. Let's define `\(m_i\)` as the variable indicating if the `\(i-th\)` observation is missing

`$$m_i \sim \text{Bernoulli}(p_i)$$`

1\. .red[Missing completely at random] (MCAR) occurs when the missing data are independent from the observed or unobserved data: 

`$$\text{logit}(p_i) = \theta_0$$`
This means that the missing values can be ignored and the analysis can be conducted as usual. 

---

# Different types of missing data: MAR and MNAR

2\. .red[Missing at random] (MAR) occurs when the missing data depends ONLY on the observed data: 

`$$\text{logit}(p_i) = \theta_0 + \bf{x}_i \mathbf{\theta}_1$$`
 In this case, this can be introduced into the model so that missing observations are imputed as part of the model fitting.
 
--

&lt;span style="display:block; margin-top: 40px ;"&gt;&lt;/span&gt;

3\. .red[Missing non at random] (MNAR) occurs when the missing data depends on both the observed and missing data: 

`$$\text{logit}(p_i) = \theta_0 + \bf{x}_i \mathbf{\theta}_1 + \lambda y_i$$`

This scenario is difficult to tackle since there is no information about the missingness mechanism and the missing data.

---

# Missing response or missing covariates

- Additionally, it is crucial to distinguish between missing values .blue[in the response] and .blue[in the covariates]. 

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

- When the missingness is in the response (and it is MCAR or MAR), these can naturally be predicted as the distribution of the response values is determined by the statistical model to be fit (posterior predictive distribution in the Bayesian approach)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

- Missingness in the covariats requires additional steps:
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - a model needs to be specified on the covariate (imputation model) if the missingness mechanism is MCAR or MAR
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - an additional model of missingness needs to be specified if the mechanism is MNAR
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;  
  - Here we will consider only missing values in the response
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;  
  - `R-INLA` reguires a certain degree of complexity to deal with missing values in covariates, if you are interested in learning more look at 
  

---

name: example

&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**Example: height and weight of children**]]]


---

# Example: height and weight of children

- Information of 10,030 children measured within the Fifth Dutch Growth Study 2009 

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- Data available from the `fdgs` dataset in the `library(mice)` 

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;



&lt;table class=" lightable-classic" style='font-family: "Arial Narrow", "Source Sans Pro", sans-serif; width: auto !important; margin-left: auto; margin-right: auto;'&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Variable &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Description &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Missing &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; id &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Child ID &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; reg &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Region (5 levels) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; age &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Age (year) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; sex &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Sex &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; hgt &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Height (cm) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 23 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; wgt &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Weight (kg) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; hgt.z &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Re-scaled height (as a Z-score) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 23 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; wgt.z &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Re-scaled weight (as a Z-score) &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
---
# Summarising the data

- The data can be summarised using


```r
&gt; summary(fdgs)
```

```
       id            reg            age              sex            hgt             wgt              hgt.z               wgt.z         
 Min.   :100001   North: 732   Min.   : 0.008214   boy :4829   Min.   : 46.0   Min.   :  2.585   Min.   :-4.470000   Min.   :-5.04000  
 1st Qu.:106353   East :2528   1st Qu.: 1.618754   girl:5201   1st Qu.: 83.8   1st Qu.: 11.600   1st Qu.:-0.678000   1st Qu.:-0.62475  
 Median :203855   South:2931   Median : 8.084873               Median :131.5   Median : 27.500   Median :-0.019000   Median : 0.02600  
 Mean   :180091   West :2578   Mean   : 8.157936               Mean   :123.9   Mean   : 32.385   Mean   :-0.006054   Mean   : 0.04573  
 3rd Qu.:210591   City :1261   3rd Qu.:13.547570               3rd Qu.:162.3   3rd Qu.: 51.100   3rd Qu.: 0.677000   3rd Qu.: 0.70700  
 Max.   :401955                Max.   :21.993155               Max.   :208.0   Max.   :135.300   Max.   : 3.900000   Max.   : 4.74100  
                                                               NA's   :23      NA's   :20        NA's   :23          NA's   :20        
```

- Note that several variables in the dataset have missing observations. In particular, height `(hgt)` and weight `(wgt)`, which are common variables used as response or predictors in models

---

# Subsetting the data

- In order to provide a smaller dataset to speed up computations, only the children with missing values (in height and weight) and another 1000 ones taken at random will be used in the analysis


```r
&gt; # Subsect 1, observations with NA's
&gt; subset1 &lt;- which(is.na(fdgs$wgt) | is.na(fdgs$hgt))
&gt; 
&gt; #Subset 2, random sample of 1000 individuals
&gt; set.seed(1)
&gt; subset2 &lt;- sample((1:nrow(fdgs))[-subset1], 1000)
&gt; # Subset 1 + subset 2
&gt; fdgs.sub &lt;- fdgs[c(subset1, subset2), ]
&gt; summary(fdgs.sub)
```

```
       id            reg           age             sex           hgt              wgt              hgt.z              wgt.z        
 Min.   :100098   North: 78   Min.   : 0.07118   boy :493   Min.   : 46.00   Min.   :  2.585   Min.   :-4.26300   Min.   :-4.0750  
 1st Qu.:106293   East :275   1st Qu.: 1.74264   girl:550   1st Qu.: 86.28   1st Qu.: 11.960   1st Qu.:-0.66800   1st Qu.:-0.6520  
 Median :204306   South:298   Median : 8.59411              Median :136.05   Median : 29.000   Median :-0.04550   Median :-0.0070  
 Mean   :183214   West :250   Mean   : 8.56536              Mean   :127.04   Mean   : 33.614   Mean   :-0.02313   Mean   : 0.0202  
 3rd Qu.:211388   City :142   3rd Qu.:14.16427              3rd Qu.:165.10   3rd Qu.: 53.100   3rd Qu.: 0.64550   3rd Qu.: 0.6960  
 Max.   :401949               Max.   :21.88364              Max.   :199.00   Max.   :117.300   Max.   : 3.20000   Max.   : 3.6300  
                                                            NA's   :23       NA's   :20        NA's   :23         NA's   :20       
```
---
name: model

&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**Bayesian imputation**]]]


---

# Model specification


- We first predict weight as a function of age and sex. We specify:
`$$wgt_i \sim \text{Normal}(\alpha+\beta_1 sex_i + \beta_2 age_i, \sigma^2)$$`
- where `wgt` is missing we will have `NA` in the corresponding vector, e.g.

```r
&gt; fdgs.sub$wgt[1:10]
```

```
 [1] 23.200     NA     NA     NA  8.445     NA  6.960 10.420     NA 14.100
```
 
- Remember the posterior predictive distribution (presented in lecture 2.2):

	`$$p(\mathbf{y}^*|\mathbf{y}) = \int p(y^*|\theta)p(\theta|\mathbf{y})d\theta$$`

  - here `\(\mathbf{y}^*\)` identifies the missing values, while `\(\mathbf{y}\)` is the set of observed values for `wgt` 

---

# Running the model in `R-INLA`


```r
&gt; library("INLA")
&gt; wgt.inla &lt;- inla(wgt ~ age + sex, data = fdgs.sub,
+ control.predictor = list(compute = TRUE), control.compute=list(return.marginals.predictor=TRUE))
&gt; wgt.inla$summary.fixed
```

```
                 mean         sd 0.025quant  0.5quant 0.975quant      mode         kld
(Intercept)  6.259187 0.43576270   5.404524  6.259188   7.113849  6.259188 8.95248e-12
age          3.330942 0.03367352   3.264898  3.330942   3.396986  3.330942 8.61623e-12
sexgirl     -2.378945 0.44587122  -3.253432 -2.378945  -1.504455 -2.378945 8.93984e-12
```

```r
&gt; wgt.inla$summary.hyperpar
```

```
                                              mean           sd 0.025quant   0.5quant 0.975quant       mode
Precision for the Gaussian observations 0.01972943 0.0008729198 0.01805322 0.01971746 0.02147696 0.01969183
```

- Note that we need to include `control.predictor=list(compute = TRUE)` so `INLA` can estimate the predictive distribution for the missing observations, while `control.compute=list(return.marginals.predictor=TRUE)` tells inla that we want to access the entire posterior distribution of the prediction (rather than only the summary)

---

# Getting the posterior prediction

We now subset the children indexes with missing values so we can report their predictive distributions:


```r
&gt; wgt.na &lt;- which(is.na(fdgs.sub$wgt))
&gt; rownames(fdgs.sub)[wgt.na]
```

```
 [1] "275"  "1278" "1419" "2135" "2684" "2940" "3069" "3189" "3543" "4262" "5687" "6485" "7101" "7108" "7506" "8064" "8065" "8067" "8098" "8588"
```

```r
&gt; # Obtain the predictive distribution
&gt; wgt.inla$summary.fitted.values[wgt.na, c("mean", "sd")][1:5,]
```

```
                           mean        sd
fitted.Predictor.0002 23.067927 0.3200569
fitted.Predictor.0003 27.617341 0.3328551
fitted.Predictor.0004 54.019923 0.3765046
fitted.Predictor.0006 13.144502 0.3926908
fitted.Predictor.0009  7.838159 0.3936613
```

Remember that you can also access the marginal posterior distributions (rather than the summary) using `wgt.inla$marginals.fitted.values`
---

# Imputing `hgt` using the same approach

- Similarly, a model can be fit to explain height based on age and sex and to compute the predictive distribution of the missing observations:


```r
&gt; hgt.inla &lt;- inla(hgt ~ age + sex, data = fdgs.sub,
+ control.predictor = list(compute = TRUE),
+ control.compute = list(return.marginals.predictor=TRUE))
&gt; hgt.inla$summary.fixed
```

```
                 mean         sd 0.025quant  0.5quant 0.975quant      mode          kld
(Intercept) 77.148117 0.72109712  75.733811 77.148118  78.562415 77.148118 1.005731e-11
age          6.022575 0.05549259   5.913736  6.022575   6.131413  6.022575 1.096012e-11
sexgirl     -4.716069 0.73116459  -6.150109 -4.716071  -3.282014 -4.716071 1.096018e-11
```

```r
&gt; hgt.inla$summary.hyperpar
```

```
                                               mean           sd  0.025quant   0.5quant  0.975quant        mode
Precision for the Gaussian observations 0.007403866 0.0003304386 0.006769282 0.00740418 0.008066786 0.007423371
```

---

# Imputing `hgt` using the same approach

.pull-left[
&lt;span style="display:block; margin-top: 24px ;"&gt;&lt;/span&gt;
- We can obtain the predictions using



```r
&gt; hgt.na &lt;- which(is.na(fdgs.sub$hgt))
&gt; hgt.inla$summary.fitted.values[hgt.na, c("mean", "sd")][1:10,]
```

```
                           mean        sd
fitted.Predictor.0001 122.24529 0.5361333
fitted.Predictor.0005  83.24901 0.6840796
fitted.Predictor.0007  74.64156 0.6794198
fitted.Predictor.0008  82.80381 0.6866698
fitted.Predictor.0010  88.26140 0.6020496
fitted.Predictor.0012  96.55557 0.6143018
fitted.Predictor.0013  86.31595 0.6666480
fitted.Predictor.0016  81.84746 0.6922833
fitted.Predictor.0017  77.75821 0.7170109
fitted.Predictor.0018  81.59988 0.6379852
```
]

.pull-right[
- We can plot the entire posterior distributions for each child with:

```r
&gt; # First child with missing value
&gt; plot(hgt.inla$marginals.fitted.values[[hgt.na[1]]], type="l")
```

&lt;img src="./img/unnamed-chunk-11-1.png" style="display: block; margin: auto;" width="80%"&gt;
]

---



name: extending

&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**Extending the model**]]]


---


# Joint model of height and weight

- The two previous models consider height and weight separately, but it is clear that there is a high correlation between height and weight, which is caused by the age and sex of the child. 


```
[1] 0.9999865
```
- We can build a joint model for height and weight to exploit a correlated effect between the coefficients of age in both models.

`\begin{align*}
hgt_i &amp;= \alpha_h + \beta_{h1} sex_i + \beta_{h2} age_i + \epsilon_{1i}\\
wgt_i &amp;= \alpha_w + \beta_{w1} sex_i + \beta_{w2} age_i + \epsilon_{2i}\\
\end{align*}`

with 
  - `\(\alpha_h,\alpha_w\)` model intercepts
  - `\(\beta_{h1},\beta_{w1}\)` the effect of sex
  - `\(\beta_{h2},\beta_{w2}\)` the effect of age
  - `\(\mathbf{\epsilon_{1}},\mathbf{\epsilon}_{2}\)` the error terms (note that this specification is equivalent to the one above for the separate models)
  
---

# Joint model of height and weight: prior

- The vectors `\((\mathbf{\beta}_{1h}, \mathbf{\beta}_{1w})\)` and `\((\mathbf{\beta}_{2h}, \mathbf{\beta}_{2w})\)` are modeled using a multivariate Gaussian distribution with mean 0 and covariance matrix with `\(1/\tau_{hj}\)` and `\(1/\tau_{wj}\)` as variances and `\(\rho_j  / \sqrt{(\tau_{jh} \tau_{jw})}\)` as the covariance where `\(\rho_j\)` is the correlation parameter.

- First, the bivariate response variable needs to be put in a two-column matrix given that the model will be made of two data distributions


```r
&gt; n &lt;- nrow(fdgs.sub)
&gt; y &lt;- matrix(NA, nrow = 2 * n, ncol = 2)
&gt; y[1:n, 1] &lt;- fdgs.sub$hgt
&gt; y[n + 1:n, 2] &lt;- fdgs.sub$wgt
```

- Similarly, as we have two intercepts, we need to define these explicitly as covariates with all values equal to one:

```r
&gt; I &lt;- matrix(NA, nrow = 2 * n, ncol = 2)
&gt; I[1:n, 1] &lt;- 1
&gt; I[n + 1:n, 2] &lt;- 1
```

---

# Correlated effects

- Now we need to define the correlated effects. We will use the random effect specification similar to what we saw with the hierarchical models (`iid`), but modified to have the two coefficients as correlated `f(...,model=iid2d)`. 

- In order to do so we need to modify the variables `age` and `sex` as they will be passed to the model as weights of the latent random effects `iid2d` specification. We need them to be twice as long to match the dimension of the response:


```r
&gt; age.joint &lt;- rep(fdgs.sub$age, 2)
&gt; sex.joint &lt;- rep(fdgs.sub$sex, 2)
```

- Finally we need two index vectors to indicate which coefficient to use from the `iid2d` model is required. These indexes will be 1 for the first half of observations (to indicate that the coefficient is `\(\beta_h\)` and 2 for the second half (to indicate that the coefficient is `\(\beta_w\)`).


```r
&gt; idx.age = rep(1:2, each = n)
&gt; idx.sex = rep(1:2, each = n)
```

---

# Model fitting



The model is fit and summarized as seen below

```r
&gt; # Model formula
&gt; joint.f &lt;- y ~ -1 + I + f(idx.sex, sex, model="iid2d", n=2) + f(idx.age, age, model = "iid2d", n = 2) 
&gt; # Model fit
&gt; fdgs.joint &lt;- inla(joint.f, 
+   data = list(y = y, I = I, sex = sex.joint, age = age.joint, idx.age = idx.age, idx.sex= idx.sex),
+   family = rep("gaussian", 2),
+   control.predictor = list(compute = TRUE))
&gt; # Summary fixed (intercept)
&gt; fdgs.joint$summary.fixed
```

```
        mean        sd 0.025quant  0.5quant 0.975quant      mode          kld
I1 81.124354 1.1467496   78.89268 81.118125  83.391094 81.117990 7.177745e-09
I2  8.512301 0.6799152    7.18675  8.509552   9.853253  8.509475 4.004876e-09
```

---

# Hyperparameters and variable effects

- The hyperparameters can be obtained through


```r
&gt; fdgs.joint$summary.hyperpar
```

```
                                                  mean           sd  0.025quant   0.5quant  0.975quant        mode
Precision for the Gaussian observations    0.007381468 0.0003158389 0.006760246 0.00738111 0.008003156 0.007395552
Precision for the Gaussian observations[2] 0.019730455 0.0008577595 0.017983707 0.01974962 0.021349126 0.019890956
Precision for idx.sex (component 1)        0.229098980 0.0421660917 0.147725213 0.22842312 0.310628523 0.234393163
Precision for idx.sex (component 2)        0.752987237 0.1325558166 0.530631196 0.73997939 1.051043080 0.711889033
Rho1:2 for idx.sex                         0.913712999 0.0150280999 0.885675060 0.91371111 0.943606611 0.910155893
Precision for idx.age (component 1)        0.344366034 0.0564052256 0.252994487 0.33791276 0.474058828 0.321423805
Precision for idx.age (component 2)        1.132872604 0.1700804329 0.828579940 1.12244242 1.496724034 1.105970743
Rho1:2 for idx.age                         0.843269536 0.0278518255 0.779593953 0.84634295 0.888782528 0.854107618
```

- While the coefficients for `age` and `sex` are part of the random effects of the model:
.pull-left[

```r
&gt; #Sex
&gt; fdgs.joint$summary.random$idx.sex
```

```
  ID      mean        sd 0.025quant  0.5quant 0.975quant      mode          kld
1  1 -4.235610 0.6346222  -5.496296 -4.229926  -3.006712 -4.229748 1.903061e-08
2  2 -2.285555 0.3740273  -3.026223 -2.282892  -1.559643 -2.282772 1.212372e-08
```
]

.pull-right[
&lt;span style="display:block; margin-top: -23px ;"&gt;&lt;/span&gt;

```r
&gt; #Age
&gt; fdgs.joint$summary.random$idx.age
```

```
  ID     mean         sd 0.025quant 0.5quant 0.975quant     mode          kld
1  1 6.021963 0.05527628   5.913552 6.021964   6.130369 6.021964 5.643357e-20
2  2 3.328917 0.03357334   3.263077 3.328916   3.394766 3.328916 1.969932e-12
```
]
---

# Estimates of missing values

- Finally to access the predicted values for the children with missing data we need to remember that we now have the response `y` stacked (first height, then weight)

- As height is the first variable we can use `hgt.na` to get to the indexes of the children with missing data

- For weight we need to use `wgt.na` and add `n` to each index, as this is the total number of observations, so the data for weight will start on the index 1044


```r
&gt; joint.wgt.na = wgt.na+n
```


```r
&gt; #Height
&gt; fdgs.joint$summary.fitted.values[hgt.na, c("mean", "sd")][1:10,]
&gt; #Weight
&gt; fdgs.joint$summary.fitted.values[joint.wgt.na, c("mean", "sd")][1:10,]
```
---

# Comparing the results of the joint and separate models

.pull-left[

.red[Weight]

&lt;img src="./img/unnamed-chunk-24-1.png" &gt;
]

.pull-right[

.red[Height]

&lt;img src="./img/unnamed-chunk-25-1.png" &gt;
]
---

# References

Gómez-Rubio, V. (2020a). _Bayesian inference with INLA_. CRC Press.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="assets/remark-zoom.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"navigation": {
"scroll": false
},
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
