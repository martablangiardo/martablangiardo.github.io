<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Session 9.2: Spatio-temporal modelling for area data</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <script src="libs/kePrint/kePrint.js"></script>
    <link href="libs/lightable/lightable.css" rel="stylesheet" />
    <!-- (Re)Defines a bunch of LaTeX commands that can then be used directly in the .Rmd file as '\command{...}' -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: {
        /* This enables color macros */
        extensions: ["color.js"],
        Macros: {
          /* Probability & mathematical symbols */
          Pr: "{\\style{font-family:inherit; font-size: 110%;}{\\text{Pr}}}",
          exp: "{\\style{font-family:inherit; font-size: 105%;}{\\text{exp}}}",
          log: "{\\style{font-family:inherit; font-size: 105%;}{\\text{log}}}",
          ln: "{\\style{font-family:inherit; font-size: 105%;}{\\text{ln}}}",
          logit: "{\\style{font-family:inherit; font-size: 100%;}{\\text{logit}}}",
          HR: "{\\style{font-family:inherit; font-size: 105%;}{\\text{HR}}}",
          OR: "{\\style{font-family:inherit; font-size: 105%;}{\\text{OR}}}",
          E: "{\\style{font-family:inherit; font-size: 105%;}{\\text{E}}}",
          Var: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Var}}}",
          Cov: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Cov}}}",
          Corr: "{\\style{font-family:inherit; font-size: 105%;}{\\text{Corr}}}",
          DIC: "{\\style{font-family:inherit; font-size: 105%;}{\\text{DIC}}}",
          se: "{\\style{font-family:inherit; font-size: 100%;}{\\text{se}}}",
          sd: "{\\style{font-family:inherit; font-size: 100%;}{\\text{sd}}}",
          kld: "{\\style{font-family:inherit; font-size: 100%;}{\\text{kld}}}",
          /* Distributions */
          dnorm: "{\\style{font-family:inherit;}{\\text{Normal}}}",
          dt: "{\\style{font-family:inherit;}{\\text{t}}}",
          ddirch: "{\\style{font-family:inherit;}{\\text{Dirichlet}}}",
          dmulti: "{\\style{font-family:inherit;}{\\text{Multinomial}}}",
          dbeta: "{\\style{font-family:inherit;}{\\text{Beta}}}",
          dgamma: "{\\style{font-family:inherit;}{\\text{Gamma}}}",
          dbern: "{\\style{font-family:inherit;}{\\text{Bernoulli}}}",
          dbin: "{\\style{font-family:inherit;}{\\text{Binomial}}}",
          dpois: "{\\style{font-family:inherit;}{\\text{Poisson}}}",
          dweib: "{\\style{font-family:inherit;}{\\text{Weibull}}}",
          dexp: "{\\style{font-family:inherit;}{\\text{Exponential}}}",
          dlnorm: "{\\style{font-family:inherit;}{\\text{logNormal}}}",
          dunif: "{\\style{font-family:inherit;}{\\text{Uniform}}}",
          /* LaTeX formatting */
          bm: ["{\\boldsymbol #1}",1],
          /* These create macros to typeset numbers in maths with the basic font */
          0: "{\\style{font-family:inherit; font-size: 105%;}{\\text{0}}}",
          1: "{\\style{font-family:inherit; font-size: 105%;}{\\text{1}}}",
          2: "{\\style{font-family:inherit; font-size: 105%;}{\\text{2}}}",
          3: "{\\style{font-family:inherit; font-size: 105%;}{\\text{3}}}",
          4: "{\\style{font-family:inherit; font-size: 105%;}{\\text{4}}}",
          5: "{\\style{font-family:inherit; font-size: 105%;}{\\text{5}}}",
          6: "{\\style{font-family:inherit; font-size: 105%;}{\\text{6}}}",
          7: "{\\style{font-family:inherit; font-size: 105%;}{\\text{7}}}",
          8: "{\\style{font-family:inherit; font-size: 105%;}{\\text{8}}}",
          9: "{\\style{font-family:inherit; font-size: 105%;}{\\text{9}}}",
          /* Health economics quantities */
          icer: "{\\style{font-family:inherit; font-size: 100%;}{\\text{ICER}}}",
          nb: "{\\style{font-family:inherit; font-size: 100%;}{\\text{NB}}}",
          ol: "{\\style{font-family:inherit; font-size: 100%;}{\\text{OL}}}",
          ceac: "{\\style{font-family:inherit; font-size: 100%;}{\\text{CEAC}}}",
          evpi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVPI}}}",
          evppi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVPPI}}}",
          evsi: "{\\style{font-family:inherit; font-size: 100%;}{\\text{EVSI}}}"
        }
      }
    });
    </script>
    <link rel="stylesheet" href="assets/beamer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">






class: title-slide

# Session 9.2: Spatio-temporal modelling for area data&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt; 

## 

###     

### Imperial College London

&lt;!-- Can also separate the various components of the extra argument 'params', eg as in 
### Imperial College London, , MSc in Epidemiology / Health Data Analytics
--&gt;



---

layout: true  

.my-footer[ 
.alignleft[ 
&amp;nbsp; &amp;copy; Marta Blangiardo | Monica Pirani 
]
.aligncenter[
MSc in Epidemiology / Health Data Analytics 
]
.alignright[
Imperial College London, NA 
]
] 



---

# Learning Objectives

At the end of this session you should be able to:

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;


- Explain how to extend spatial or temporal models to spatio-temporal models 


&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;


- Fit Bayesian space-time models using `R-INLA`


&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;


The topics covered in this lecture can be found in Chapter 7 of the book Spatial and **Spatio-Temporal Bayesian Models with `R-INLA`**.  

---

# Outline 

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

1\. [Temporal dependence](#temporal-structure)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

2\. [From space to space-time](#space-to-time)

&lt;span style="display:block; margin-top: 30px ;"&gt;&lt;/span&gt;

3\. [Type of interactions](#interactions)

---

name: temporal-structure
  
&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**Temporal dependence**]]]

---

# Temporal dependence

- Similarly to spatial dependence, it is sometimes necessary to model temporal dependence of data or of parameters:

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

   - the weekly or monthly number of cases of many diseases exhibit often a seasonal pattern as well as short term dependence

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

   - the underlying daily level of atmospheric pollutants, e.g. PM `\(_{10}\)`, will show strong correlation over consecutive days
    because their lifetime lasts over several days

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- To the contrary of spatial models, there is a natural order to any time series data which is used in specifying the models.

---

# Spatial patterns

1\. Data
  - Disease counts `\(y_{i}\)` in area `\(i\)` and stratum `\(k\)`, aggregated over a time period, `\(i=1,\ldots,N\)`, `\(k=1,\ldots,K\)`
  &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{ik}\)` in area `\(i\)` and stratum `\(k\)`, aggregated over a time period
  &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_i = \sum_k n_{ik} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)


2\. Spatial smoothing using BYM model

`\begin{align*}
y_i &amp; \sim  \hbox{Poisson}(E_i \rho_i); \;\;\; i=1,...,N\\
\eta_i = \log \rho_i &amp; =  b_0 + b_i\\
\boldsymbol{b} &amp;= \frac{1}{\sqrt{\tau_b}}(\sqrt{1-\phi}\boldsymbol{v}_{*} + \sqrt{\phi}\boldsymbol{u}_{*})
\end{align*}`

---

# Ohio Lung cancer spatial pattern 


- Data on lung cancer in 88 counties of Ohio, 1968-1988

- Purely spatial analysis



&lt;img src="./img/unnamed-chunk-3-1.png" &gt;
---

# Temporal trends

1\. Data

  - Disease counts `\(y_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space,  `\(t=1,\ldots,T\)` (equally-spaced time intervals), `\(k=1,\ldots,K\)` &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space 
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_t = \sum_k n_{tk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

Note that `\(E_t\)` makes sense if the time series covers a long period, e.g. years, otherwise it is common to assign `\(E_t = \sum_t y_t / T\)`

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

2\. Temporal trends

`\begin{align*}
y_t &amp; \sim  \hbox{Poisson}(E_t \rho_t); \;\;\; t=1,...,T\\
\log \rho_t &amp; =  ???
\end{align*}`

---

count:false

# Temporal trends

1\. Data

  - Disease counts `\(y_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space,  `\(t=1,\ldots,T\)` (equally-spaced time intervals), `\(k=1,\ldots,K\)` &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space 
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_t = \sum_k n_{tk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

Note that `\(E_t\)` makes sense if the time series covers a long period, e.g. years, otherwise it is common to assign `\(E_t = \sum_t y_t / T\)`

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

2\. Temporal trends

`\begin{align*}
y_t &amp; \sim  \hbox{Poisson}(E_t \rho_t); \;\;\; t=1,...,T\\
\log \rho_t &amp; =  b_0 + \beta t \quad \hbox{ simple linear regression}\\
\end{align*}`

---

count:false

# Temporal trends

1\. Data

  - Disease counts `\(y_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space,  `\(t=1,\ldots,T\)` (equally-spaced time intervals), `\(k=1,\ldots,K\)` &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space 
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_t = \sum_k n_{tk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

Note that `\(E_t\)` makes sense if the time series covers a long period, e.g. years, otherwise it is common to assign `\(E_t = \sum_t y_t / T\)`

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

OR

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

2\. Temporal trends

`\begin{align*}
y_t &amp; \sim  \hbox{Poisson}(E_t \rho_t); \;\;\; t=1,...,T\\
\log \rho_t &amp; =   b_0 + \psi_t \quad \hbox{ global temporal smoothing}\\
&amp; \psi_t \sim \hbox{Normal}(0, \sigma^2_{\psi})\\
\end{align*}`


---

count:false

# Temporal trends

1\. Data

  - Disease counts `\(y_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space,  `\(t=1,\ldots,T\)` (equally-spaced time intervals), `\(k=1,\ldots,K\)` &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space 
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_t = \sum_k n_{tk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

Note that `\(E_t\)` makes sense if the time series covers a long period, e.g. years, otherwise it is common to assign `\(E_t = \sum_t y_t / T\)`

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

OR

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

2\. Temporal trends

`\begin{align*}
y_t &amp; \sim  \hbox{Poisson}(E_t \rho_t); \;\;\; t=1,...,T\\
\log \rho_t &amp; =   b_0 + \gamma_t \quad \hbox{ local temporal smoothing}\\
&amp;    \gamma_t \sim RW(\sigma^2_{\gamma})\\
\end{align*}`

---

count:false

# Temporal trends

1\. Data

  - Disease counts `\(y_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space,  `\(t=1,\ldots,T\)` (equally-spaced time intervals), `\(k=1,\ldots,K\)` &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Population counts `\(n_{tk}\)` in time period `\(t\)` and stratum `\(k\)`, aggregated over space 
&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  - Expected numbers `\(E_t = \sum_k n_{tk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

Note that `\(E_t\)` makes sense if the time series covers a long period, e.g. years, otherwise it is common to assign `\(E_t = \sum_t y_t / T\)`

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

OR

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

2\. Temporal trends

`\begin{align*}
y_t &amp; \sim  \hbox{Poisson}(E_t \rho_t); \;\;\; t=1,...,T\\
\log \rho_t &amp; =   b_0 + \gamma_t + \psi_t \quad \hbox{ global and local temporal smoothing}\\
&amp; \psi_t \sim \hbox{Normal}(0, \sigma^2_{\psi})\\
&amp;    \gamma_t \sim RW(\sigma^2_{\gamma})\\
\end{align*}`


---

# Ohio Lung cancer data: modelled temporal trend

- Annual rates adjusted by gender and race

- Fitting different temporal trends (linear, .red[local smoothing], .blue[local+global smoothing])

&lt;img src="./img/ohio-rw-1.png" &gt;

---



name: space-to-time
  
&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**From space to space-time**]]]

---



# Disease mapping: Extending space to space-time

- Disease mapping is usually carried out on aggregated data over a time period

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Rather than suppressing the time dimension, it can be interesting to use models that combine the space and time dimension

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- The stability (or not) of the spatial pattern can aid interpretation

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- The specific space-time components of the model can potentially pinpoint
unusual/emerging hazards

&lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;

- Data:

  - `\(y_{it}\)` 
  &lt;span style="display:block; margin-top: 10px ;"&gt;&lt;/span&gt;
  
  - `\(\hbox{E}_{it}\)`: the observed and expected number of cases in area `\(i\)` at time `\(t\)` calculated as `\(E_{it} = \sum_k n_{itk} r_k\)`, where `\(r_k\)` reference rate for stratum (age, gender,...)

---

# Dynamic spatio-temporal model

&lt;center&gt;&lt;img src=./img/representation_ST.jpg width='80%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;

---

# Ohio Lung cancer - temporal SMRs

Log SMR time trends in each county

  - Slightly increasing trend but lots of variation across the counties
  
&lt;img src="./img/ohio-ST-1.png" &gt;

---

# Model 1: linear time + space

`\begin{align*}
y_{it} &amp; \sim  \hbox{Poisson}(\hbox{E}_{it} \rho_{it}) \\
\log\rho_{it} &amp; =  b_0 + \beta \times t + b_i\\
\end{align*}`
where

- `\(b_0\)` overall log RR in Ohio over the 21-year period

- `\(b_i\)` is the weighted average of spatially structured (ICAR) and unstructured random effects  

- `\(\exp(\beta)\)` is the change in the RR associated with a 1-year increase in time


```r
&gt; formula.mod1 = y ~ 1 + year + f(county,model="bym2",
+                    graph=Ohio.adj) 
```


```r
&gt; mod1 = inla(data=ohio.data,formula=formula.mod1, E=E, family="poisson", control.compute=list(waic=TRUE))
```

Additional temporal random effects can be added...

---

# Model 2: linear time + space + structured time

`\begin{align*}
y_{it} &amp; \sim  \hbox{Poisson}(\hbox{E}_{it} \rho_{it}) \\
\log\rho_{it} &amp; =  b_0 + \beta\times t + b_i + \color{red}{\gamma_t}\\
\end{align*}`

where

- `\(b_0\)` overall log RR in Ohio over the 21-year period

- `\(b_i\)` is the weighted average of spatially structured (ICAR) and unstructured random effects  

- `\(\exp(\beta)\)` is the change in the RR associated with a 1-year increase in time

- Looking back at the purely temporal analysis it seems a random walk was able to explain the local changes in time `\(\color{red}{\gamma_t  \sim \hbox{Normal}(\gamma_{t-1}, \sigma^2_{\gamma})}\)` 


```r
&gt; year2&lt;-ohio.data$year
&gt; formula.mod2 = y ~ 1  + 
+                   year + f(county,model="bym2",
+                   graph=Ohio.adj) + 
+                   f(year2,model="rw1")
```


```r
&gt; mod2 = inla(data=ohio.data,formula=formula.mod2, E=E, family="poisson", control.compute=list(waic=TRUE))
```
---

# Comparing model 1 and 2: Fixed effects


```r
&gt; mod1$summary.fixed
```

```
                   mean         sd  0.025quant    0.5quant  0.975quant        mode          kld
(Intercept) -0.98833298 0.11238994 -1.20942022 -0.98831790 -0.76733070 -0.98831791 1.473316e-08
year         0.02612109 0.00058628  0.02497146  0.02612109  0.02727073  0.02612109 5.527834e-11
```

```r
&gt; mod2$summary.fixed
```

```
                   mean        sd 0.025quant    0.5quant 0.975quant        mode          kld
(Intercept) -1.22479528 1.8557469 -4.8996262 -1.22480743   2.450109 -1.22480615 9.030057e-08
year         0.04083632 0.1683598 -0.2925939  0.04083756   0.374259  0.04083742 9.099081e-08
```

---

# Comparing model 1 and 2: Fitted values

&lt;img src="./img/comp2-1.png" &gt;

---
# Model 3: space + structured time + unstructured time

- Exploring if a combination of random effects could be more flexible in capturing the temporal trend than a linear trend

`\begin{align*}
y_{it} &amp; \sim  \hbox{Poisson}(\hbox{E}_{it} \rho_{it}) \\
\log\rho_{it} &amp; =  b_0 + b_i + \color{red}{\gamma_t} + \color{red}{\psi_t}\\
\end{align*}`

where

- `\(b_0\)` overall log RR in Ohio over the 21-year period

- `\(b_i\)` is the weighted average of spatially structured (ICAR) and unstructured random effects  

- The temporal pattern is now modelled with two random effects (global + local smoothing) 


```r
&gt; formula.mod3 = y ~ 1  + 
+                   f(county,model="bym2", graph=Ohio.adj) + 
+                   f(year,model="rw1") +
+                   f(year2, model="iid")
```


```r
&gt; mod3 = inla(data=ohio.data,formula=formula.mod3, E=E, family="poisson", control.compute=list(waic=TRUE))
```
---

# Comparing model 1 and 3: Fixed effects


```r
&gt; mod1$summary.fixed
```

```
                   mean         sd  0.025quant    0.5quant  0.975quant        mode          kld
(Intercept) -0.98833298 0.11238994 -1.20942022 -0.98831790 -0.76733070 -0.98831791 1.473316e-08
year         0.02612109 0.00058628  0.02497146  0.02612109  0.02727073  0.02612109 5.527834e-11
```

```r
&gt; mod3$summary.fixed
```

```
                  mean        sd 0.025quant   0.5quant 0.975quant       mode          kld
(Intercept) -0.7759713 0.1580754  -1.086885 -0.7759578 -0.4651329 -0.7759577 1.536133e-08
```

---

# Comparing model 2 and 3: Fitted values

&lt;img src="./img/comp5-1.png" &gt;
---

# Do we need space-time interactions in spatio-temporal models?

- When we have temporal random effects, if we look at area specific trends this is what we would see:

&lt;center&gt;&lt;img src=./img/ohio10.jpeg width='40%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;

.red[Parallel lines as the temporal trend is assumed to be the same across all the spatial units]

---


# Space-time model with exchangeable interactions

- It is easy to allow for spatio-temporal interactions, which add flexibility to the model

- A general specification of the model will be

`\begin{align*}
y_{it} &amp; \sim  \hbox{Poisson}(\hbox{E}_{it} \rho_{it}) \\
\log\rho_{it} &amp; =  b_0 + b_i + \;\gamma_t + \psi_t + \color{blue}{\delta_{it}}\\
b_i &amp; =  v_i + u_i\\
\gamma_t &amp; \sim  \hbox{RW(1)}\\
\psi_t &amp; \sim  \hbox{N}(0,\sigma^2_{\psi})\\
\color{blue}{\delta_{it}} &amp; \color{blue}{\sim  \hbox{Normal}(0, \sigma^2_{\delta})}
\end{align*}`

The **space-time interaction parameter**, `\(\delta_{it}\)`, is modelled as
exchangeable random effects, that capture departure from the
additive structure (given by the BYM2 in space and RW1+iid in time).

---

# Interpretation of the interactions 

- The interactions `\(\delta_{it}\)` allow to highlight unusual temporal trends

- Rules based on the posterior probabilities `\(p(\delta_{it} &gt; 0)\)` for at least 1 time `\(t\)`

.pull-left[
"usual" temporal trends

&lt;center&gt;&lt;img src=./img/ohio14.jpeg width='70%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;
]

.pull-right[
unusual temporal trends
&lt;center&gt;&lt;img src=./img/ohio13.jpeg width='70%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;
]


---

# INLA code for model with interaction

- In INLA is very easy to include the interaction in the `formula` environment

- We need to specify an index for the interaction, i.e. for each combination of area/time  

`\begin{align*}
\log\rho_{it} &amp; =  b_0 + b_i + \gamma_t + \psi_t + \delta_{it}\\
\gamma_t &amp; \sim  \hbox{RW(1)}\\
\psi_t &amp; \sim  N(0,\sigma^2_{\psi})\\
\delta_{it}  \sim &amp; \hbox{Normal}(0, \sigma^2_{\delta})
\end{align*}`


```r
&gt; formula.intI = y ~ + f(county,model="bym2",
+                        graph=Ohio.adj) +
+                       f(year,model="rw1") +
+                       f(year2,model="iid") +
+                       f(area.year,model="iid")
```


---

name: interactions
  
&lt;span style="display:block; margin-top: 250px ;"&gt;&lt;/span&gt;

.myblue[.center[.huge[
**Types of interactions**]]]

---

# Another example: Birth weight in Georgia

- Count of babies weigthing less than 2500g in 159 counties in Georgia (US)
- Period 2000 – 2010

&lt;img src="./img/Georgia_SMR-1.png" style="display: block; margin: auto;" width="55%"&gt;

---

# Different types of interactions 

`\begin{align*}
y_{it} &amp; \sim  \hbox{Poisson}(\hbox{E}_{it} \rho_{it}) \\
\log \rho_{it} &amp; =  b_0 + b_i  + \gamma_t + \psi_t + \color{blue}{\delta_{it}}\\
b_i &amp; = v_i + u_i\\
\gamma_t &amp; \sim  \hbox{RW(1)}\\
\psi_t &amp; \sim  N(0,\sigma^2_{\psi})\\
\end{align*}`

&lt;table class="table" style="margin-left: auto; margin-right: auto;"&gt;
&lt;caption&gt;Characteristics of ST interaction&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Interaction &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Parameters &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Rank &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; I &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Unstructured in space  and Unstructured in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; nT &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; II &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Unstructured in space  and RW in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; n(T-1) for RW1, n(T-2) for RW2 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; III &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; ICAR in space  and Unstructured in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; (n-1)T &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; IV &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; ICAR in space  and RW in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; (n-1)(T-1) for RW1, (n-1)(T-2) for RW2 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

# How to model interactions

- Data in R format

```
# A tibble: 1,749 × 8
   ID.area   Obs ID.year   Exp     y     E NAME    ID.area.year
     &lt;int&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;          &lt;int&gt;
 1       1    20       1  25.8    20  25.8 Appling            1
 2       1    24       2  25.1    24  25.1 Appling            2
 3       1    25       3  22.8    25  22.8 Appling            3
 4       1    31       4  25.2    31  25.2 Appling            4
 5       1    24       5  24.9    24  24.9 Appling            5
 6       1    40       6  26.7    40  26.7 Appling            6
 7       1    29       7  26.0    29  26.0 Appling            7
 8       1    35       8  27.2    35  27.2 Appling            8
 9       1    26       9  25.1    26  25.1 Appling            9
10       1    25      10  24.5    25  24.5 Appling           10
# ℹ 1,739 more rows
```

&lt;span style="display:block; margin-top: -10px ;"&gt;&lt;/span&gt;

- We need to make sure to have an index for area (`ID.area`), one for time (`ID.year`) and one for the interaction (`ID.area.year`)

---

# Type I interaction in INLA

Let's adopt Type I interaction, which assumes that the two unstructured effects `\(v_i\)` and `\(\psi_t\)` interact

&lt;span style="display:block; margin-top: -10px ;"&gt;&lt;/span&gt;





```r
&gt; Georgia.adj = "Georgia.graph"
&gt; ID.year2 = data_INLA$ID.year
&gt; formula.intI = y ~ + f(ID.area,model="bym2",
+                        graph=Georgia.adj) +
+                      f(ID.year,model="rw1") +
+                      f(ID.year2,model="iid") +
+                      f(ID.area.year,model="iid")
```

&lt;center&gt;&lt;img src=./img/INLA_ST1_mod-1.png width='40%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;


---

# Kronecker product

- For the interactions of type II-IV we will need to use the **Kronecker product** to specify the dependencies. It is a matrix multiplication which returns a block matrix.

For instance
`$$\left[\begin{array}{cc}
1 &amp; 2 \\ 3 &amp; 4
\end{array}\right] \otimes
\left[ \begin{array}{cc}
 0 &amp; 5 \\ 6 &amp; 7
 \end{array} \right] = \left[
\begin{array}{cc}
1 \left[\begin{array}{cc}
0 &amp; 5\\
6 &amp; 7
\end{array}\right] &amp; 2 \left[\begin{array}{cc}
0 &amp; 5\\
6 &amp; 7
\end{array}\right] \\
3 \left[\begin{array}{cc}
0 &amp; 5\\
6 &amp; 7
\end{array}\right] &amp; 4 \left[\begin{array}{cc}
0 &amp; 5\\
6 &amp; 7
\end{array}\right]
\end{array}\right]$$`

- There is a function in `R` which does exactly that: `kronecker(a,b)`

- Type II-IV of interactions are pretty complex and can take a **very long** time to run

- We breifly discuss, but for more information on how to set interactions using the Kronecker product in `INLA` see Goicoa, Adin, Ugarte, and Hodges (2018)
---

# Type II interaction: in INLA

- Type II combines the structured temporal main effect `\(\gamma_t\)` and the unstructured
spatial effect `\(v_i\)`.

- We use first create the structure matrix for the time component assuming a random walk of order 1

```r
&gt; #RW1
&gt; D1 &lt;- diff(diag(11),differences=1)
&gt; Q.gammaRW1 &lt;- t(D1)%*%D1
&gt; #Let's look at it
&gt; Q.gammaRW1[1:5,1:5]
```

```
     [,1] [,2] [,3] [,4] [,5]
[1,]    1   -1    0    0    0
[2,]   -1    2   -1    0    0
[3,]    0   -1    2   -1    0
[4,]    0    0   -1    2   -1
[5,]    0    0    0   -1    2
```

---

# Type II interaction: in INLA

- Then we create the Kronecker product  `\(v \otimes\)` `\(\gamma\)` and note from the table in slide 35 that the rank deficiency is n (159 in our case)

```r
&gt; #Kronecker product (for RW1)
&gt; R &lt;- kronecker(diag(159),Q.gammaRW1)
&gt; R[1:5,1:5]
```

```
     [,1] [,2] [,3] [,4] [,5]
[1,]    1   -1    0    0    0
[2,]   -1    2   -1    0    0
[3,]    0   -1    2   -1    0
[4,]    0    0   -1    2   -1
[5,]    0    0    0   -1    2
```

---

# Type II interaction: in INLA

- Finally we need to impose some more constraints as the matrix have spatio-temporal interaction matrix has a rank deficiency

- We calculate the eigenvalues of the structure matrix of the interaction term and the extra constraints are those where the eigenvalues are zero


```r
&gt; eigenQ &lt;- eigen(R)
&gt; ids &lt;- which(eigenQ$values &lt; 0.00001)
&gt; cMat &lt;- t(eigenQ$vectors[,ids])
```

The `formula` environment needs to be changed to

```r
&gt; formula.intII&lt;- y ~ f(ID.area,model="bym2",graph=Georgia.adj) +
+                     f(ID.year,model="rw1") +
+                     f(ID.year2,model="iid") +
+                     f(ID.area.year, model="generic0", Cmatrix=R, rankdef = nrow(cMat),
+                     extraconstr = list(A = cMat, e = rep(0, nrow(cMat))))
```

---

# Type II interaction: in INLA

&lt;center&gt;&lt;img src=./img/INLA_ST2_mod-1.png width='60%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;



---

# Type III interaction in INLA

- Type III combines the spatially structured main effect `\(u_i\)` and the unstructured temporal effect `\(\psi_t\)`.

- We use first create the structure matrix for the spatial component using the neighborhood graph

```r
&gt; g &lt;- inla.read.graph(Georgia.adj)
&gt; Q.xi &lt;- matrix(0, g$n, g$n)
&gt; for (i in 1:g$n){
+   Q.xi[i,i]=g$nnbs[[i]]
+   Q.xi[i,g$nbs[[i]]]=-1
+ }
&gt; Q.xi[1:5,1:5]
```

```
     [,1] [,2] [,3] [,4] [,5]
[1,]    2   -1    0    0    0
[2,]   -1    4    0    0    0
[3,]    0    0    5   -1    0
[4,]    0    0   -1    4   -1
[5,]    0    0    0   -1    4
```

---

# Type III interaction in INLA

- Then we create the Kronecker product `\(u\)` `\(\otimes\)` `\(\psi\)` and note from the table in slide 35 that the rank deficiency is T (11 in our case)

```r
&gt; #Kronecker product (for RW1)
&gt; R &lt;- kronecker(Q.xi,diag(11))
&gt; R[1:5,1:15]
```

```
     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14] [,15]
[1,]    2    0    0    0    0    0    0    0    0     0     0    -1     0     0     0
[2,]    0    2    0    0    0    0    0    0    0     0     0     0    -1     0     0
[3,]    0    0    2    0    0    0    0    0    0     0     0     0     0    -1     0
[4,]    0    0    0    2    0    0    0    0    0     0     0     0     0     0    -1
[5,]    0    0    0    0    2    0    0    0    0     0     0     0     0     0     0
```
---

# Type III interaction in INLA

- Finally we need to impose some more constraints (on the eigenvalues equal to 0)


```r
&gt; eigenQ &lt;- eigen(R)
&gt; ids &lt;- which(eigenQ$values &lt; 0.00001)
&gt; cMat &lt;- t(eigenQ$vectors[,ids])
```

The `formula` environment becomes

```r
&gt; formula.intIII&lt;- y ~ f(ID.area,model="bym2",graph=Georgia.adj) +
+                     f(ID.year,model="rw1") +
+                     f(ID.year2,model="iid") +
+                     f(ID.area.year, model="generic0", Cmatrix=R, rankdef = nrow(cMat),
+                      extraconstr = list(A = cMat, e = rep(0, nrow(cMat))))
```
---

# Type III interaction: in INLA

&lt;center&gt;&lt;img src=./img/INLA_ST3_mod-1.png width='60%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;



---

# Type IV interaction in INLA

- Type IV is the most complex type of interaction, assuming that the spatially and temporally structured effects `\(u_i\)` and `\(\gamma_t\)` interact
-  We assume that the temporal dependency structure for each area is not independent from all the other areas anymore, but depends on the temporal pattern of the neighboring areas as well


- We create the Kronecker product `\(u\)` `\(\otimes\)` `\(\gamma\)` and note from the table in slide 35 that the rank deficiency is n+T-1 (169 in our case)

```r
&gt; #Kronecker product (for RW1)
&gt; R &lt;- kronecker(Q.xi,Q.gammaRW1)
&gt; eigenQ &lt;- eigen(R)
&gt; ids &lt;- which(eigenQ$values &lt; 0.00001)
&gt; cMat &lt;- t(eigenQ$vectors[,ids])
```

The `formula` environment becomes

```r
&gt; formula.intIV&lt;- y ~ f(ID.area,model="bym2",graph=Georgia.adj) +
+                     f(ID.year,model="rw1") +
+                     f(ID.year,model="iid") +
+                     f(ID.area.year, model="generic0", Cmatrix=R, rankdef = nrow(cMat),
+                     extraconstr = list(A = cMat, e = rep(0, nrow(cMat))))
```
---

# Type IV interaction: in INLA

&lt;center&gt;&lt;img src=./img/INLA_ST4_mod-1.png width='60%' title='INCLUDE TEXT HERE'&gt;&lt;/center&gt;



---

# Model selection

It might be useful to employ indexes like DIC and WAIC to decide which model is the most appropriate for the problem at hand

In this example:

&lt;table class="table" style="margin-left: auto; margin-right: auto;"&gt;
&lt;caption&gt;Model fitting for the different ST models&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Interaction &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Parameters &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Rank &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; DIC &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; WAIC &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; I &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Unstructured in space  and Unstructured in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; nT &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11570 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11602 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; II &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Unstructured in space  and RW in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; n(T-1) for RW1, n(T-2) for RW2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11536 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11569 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; III &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; ICAR in space  and Unstructured in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; (n-1)T &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11615 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11659 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; IV &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; ICAR in space  and RW in time &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; (n-1)(T-1) for RW1, (n-1)(T-2) for RW2 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11570 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11612 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

So we conclude that the model with the interaction of order II is the most appropriate for this data.

---


# Summary

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- Increase quality of datasets that are both spatially and temporally indexed

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- Advanced methods to deal with this type of data

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- Allow to interpret the stability (or not) of the spatial patterns

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

--

- Model selection tools are useful to choose which interaction to use 

&lt;span style="display:block; margin-top: 20px ;"&gt;&lt;/span&gt;

- Careful with interactions of order above I as they can take a **very long** time to run

---

# References

Goicoa, T., A. Adin, M. Ugarte, et al. (2018). "In spatio-temporal disease mapping models, identifiability constraints affect PQL and INLA results". In: _Stochastic Environmental Research and Risk Assessment_ 32.3, pp. 749-770.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="assets/remark-zoom.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"navigation": {
"scroll": false
},
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
