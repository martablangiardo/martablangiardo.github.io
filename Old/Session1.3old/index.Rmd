---
title: "Session 1.3: Types of Spatial Data"
params: 
   conference: "Spatial and Spatio-Temporal Bayesian Models with `R-INLA`"
   location: "University of São Paulo"
   date: 26 September 2022
   short_title: "Spatial and Spatio-Temporal Bayesian Models with `R-INLA`"

output:
  xaringan::moon_reader: 
    includes: 
       in_header: "assets/latex_macros.html" 
       # This line adds a logo based on the format selected in the file 'assets/include_logo.html'
       # NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       after_body: "assets/insert-logo.html"
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "assets/beamer.css"
---

```{r global_options, echo = FALSE, include = FALSE}
options(width = 999)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      cache = FALSE, tidy = FALSE, size = "small")
```
```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("assets/setup.R")
library(INLA)

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
#xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
#xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
#bibfile=ReadBib("~/Dropbox/Books/INLABook/ShortCourse/VIBASS/Biblio.bib",check = FALSE)

bibfile=ReadBib("C:/Users/Monica/Dropbox/VIBASS/Biblio.bib",check = FALSE)

#bibfile=ReadBib("~/Dropbox/Lavori condivisi/2015_Book/ShortCourse/VIBASS/Biblio.bib",check = FALSE)

```

class: title-slide

# `r rmarkdown::metadata$title``r vspace("10px")` `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

### `r rmarkdown::metadata$params$conference`, `r rmarkdown::metadata$params$location` 

<!-- Can also separate the various components of the extra argument 'params', eg as in 
### `r paste(rmarkdown::metadata$params, collapse=", ")`
-->

`r ifelse(is.null(rmarkdown::metadata$params$date),format(Sys.Date(),"%e %B %Y"),rmarkdown::metadata$params$date)`

---

layout: true  

.my-footer[ 
.alignleft[ 
&nbsp; &copy; Marta Blangiardo | Monica Pirani
]
.aligncenter[
`r rmarkdown::metadata$params$short_title` 
]
.alignright[
`r rmarkdown::metadata$params$conference`, `r short_date` 
]
] 

```{css,echo=FALSE, eval=FALSE}
.red {
  color: red;
}
.blue {
  color: 0.14 0.34 0.55;
}

.content-box-blue { background-color: #F0F8FF; }

}
```
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>


---

# Outline 

`r vspace("30px")`

1\. [What are the different types of spatial data](#spatialData)

`r vspace("30px")`

2\. [Spatial data in R](#SpatialR)

---

name: spatialData
  
`r vspace("250px")`

.myblue[.center[.huge[
**What are the different types of spatial data?**]]]

---


# Terminology

- The data are seen as being a realization of a stochastic process, that is, of a set of random numbers each of which is associated with a spatial location.
  - A spatial process in $d$ dimensions is denoted as:

$$\{Z(\bm{s}): \bm{s} \in \mathcal{D} \subset \mathbb{R}^d \}$$ 

where
- $Z$ is the attribute we observe (e.g. temperature, number of sudden infant deaths etc.)
`r vspace("10px")`
- $\bm{s}$ is the location where $Z$ is observed (e.g. coordinates such as latitude and longitude)
`r vspace("10px")`
- $\mathcal{D}$ is the domain, and it is called the **index set** = possible locations

`r vspace("20px")`
- Symbols are as follows: $\{\}$ a set (a collection of elements); $\in$ element of or belongs to; $\subset$ subset of; $\mathbb{R}$ real numbers set

---

# Type of spatial data

`r Citet(bibfile,"Cressie:1993")` distinguishes three types of spatial data, based on the nature of the spatial domain $\mathcal{D}$:

`r vspace("20px")`

- .red[Areal data (also known as lattice data)]: $\mathcal{D}$ is fixed (of regular or irregular shape) and partitioned into a finite number of areal units (e.g. census tract, pixels) with well-defined boundaries. 

`r vspace("20px")`

- .red[Geostatistical (or point-referenced) data]: $\mathcal{D}$ is a continuous fixed set. By continuous we mean that $Z(\bm{s})$ can be observed everywhere within $\mathcal{D}$. By fixed we mean that the points in $\mathcal{D}$ are non-stochastic. 

`r vspace("20px")`

- .red[Point pattern data]: $\mathcal{D}$ is itself random. Its index set gives the locations of random **events** that are the spatial point pattern. 

---

# Example of areal data [1]

Lattice data can be either irregularly aligned or gridded, and occur in the form of aggregated observation over areas.
`r vspace("20px")`
.pull-left[`r include_fig("poverty_US.jpg",width="65%",title="")`
.center[Percentage of people in poverty by County: 2015-2019. Source: American Community Survey 2015-2019, 5-Year Data Release.]
]

.pull-right[
- This figure is an example of a **choropleth map**, which uses shades of color (or grey scale) to classify the values of the variable that we are mapping into classes.
`r vspace("20px")`
- From the choropleth map we know which areas are adjacent which other areas. The relationship between areal units is characterized in terms of .red[adjacency].
`r vspace("20px")`
- The *sites* $\boldsymbol{s} \in \mathcal{D}$ in this case are actually the polygons themselves. 
]

---

# Example of areal data [2]

`r include_fig("Italy_Covid_March2020.jpg",width="38%",title="")`

.center[Map of the percent excess mortality for the 107 Italian provinces during the first wave of Covid-19 pandemic. Epidemiological week 18-24 March, 2020; males.]

---

# Example of regular lattice data [3]

`r include_fig("Getis-Ord.jpg",width="40%",title="")`

.center[Regular lattice: Getis-Ord remote sensing example data (from package `spdep`).]


---

# Example of geostatistical data [1]

`r include_fig("Wind_Temp_StationsUS.jpg",width="45%",title="")`

.center[Map of wind and temperature stations in US (2019).]

`r vspace("20px")`

The data are gathered at a discrete set of points in an region of interest $(\mathcal{D})$, with the aim of understanding
the behaviour of an unobserved, spatially continuous phenomenon that exists throughout that region and could, in principle, be observed at any point in $\mathcal{D}$.

---

# Example of geostatistical data [2]
.center[Average air temperature in degree Celsius (March-November 2018)]
.pull-left[
`r include_fig("Rplot_Temp_Dry2018.jpeg",width="80%",title="")`

.center[Observed]
]

.pull-right[
`r include_fig("Rplot_Temp_Pred_Dry2018.jpeg",width="57%",title="")`

.center[Predicted]
]


`r vspace("20px")`

We can reconstruct a surface from the finite set of observations taken at a finite number of spatial locations.

---

# Examples of point pattern data [1]

`r include_fig("colera.jpg",width="40%",title="")`
.center[John Snow's map of the 1854 London cholera outbreak]
`r vspace("10px")`
- In 1854, cholera hit the city of London. No one knew where the disease started. So, British physician John Snow started mapping the outbreak.
- It wasn’t just the disease. But he also mapped out roads, property boundaries, and water lines.
- When he added these features to a map, something interesting happened. He noticed that cholera cases were only along one water line. This was a breakthrough that connected geography to public health safety.
- The question of primary interest is whether, and if so where and when, statistically unusual local concentrations of cases occur.

---

# Examples of point pattern data [2]

`r include_fig("Earthquakes_Italy.jpg",width="38%",title="")`

.center[Location of earthquakes in Italy 1900-2017 (moment magnitude scale).]
`r vspace("10px")`
Other examples in which points are the location of an .red[event] of interest:
- Location of crimes
- Location of trees


---

# Data we will work with
In this course, we will work with:
`r vspace("20px")`

- Areal or lattice data
`r vspace("20px")`

- Geostatistical or spatial-referenced data

---

name: spatialR
  
`r vspace("250px")`

.myblue[.center[.huge[
**Spatial Data in R**]]]

---


# Spatial data in R: Vectors

The are two fundamental distinctions: spatial .red[vector] data and .red[raster].

- .red[Vector] represents the world using .red[points], .red[lines] and .red[polygons] or combinations of those, where:
`r vspace("20px")`
- *Point*, is a single point location, such as a geocoded address or a temperature sensor or the location of a bus stop;
`r vspace("20px")`
- *Line*, is a set of ordered points, connected by straight line segments such as route travel or connections between locations;
`r vspace("20px")`
- *Polygon*, is an area, marked by one or more enclosing lines such as local authority districts or census tracts.

---

Simple features, `sf` package `r Citet(bibfile,"Pebesma2018")` support 17 geometry types. Of these, 7 are used in the vast majority of geographic research:

`r include_fig("Features_supported_by_sf.jpg", width="40%",title="")`

Core geometry types supported by the R package sf. Source: `r Citet(bibfile,"Lovelace2019")`, Section 2.2.

---

# Spatial data in R: Rasters

- .red[Raster]: divides the surface into cells (also called pixels) of constant size. Each cell has a value associated with it, which might be numeric or categorical. 

`r vspace("20px")`

  - Raster maps usually represent continuous phenomena such as elevation, temperature, population density.
`r vspace("20px")`

  - Raster data are the basis of images used in web-mapping and have been a source of data since the origins of aerial photography and satellite-based remote sensing devices.

---

Examples of continuous and categorical raster data. 

`r include_fig("Raster_data.jpg", width="70%",title="")`

.center[Source: `r Citet(bibfile,"Lovelace2019")`, Section 2.3.]

---

# Some useful R packages 

-   `sf`, which is a recently developed package for spatial vector data (points, lines, polygons etc.) and combines the functionality of three previous packages `sp`, `rgeos` and `rgdal`. It refers to a formal standard that describes how objects in the real world can be represented in computers, with emphasis on the spatial geometry of these objects
`r vspace("10px")`
- `sp`, which precedes `sf`, and with the `rgdal` and `rgeos` package, it creates a powerful tool to works with spatial data. Many R packages still depends on the `sp` package
`r vspace("10px")`
- `spdep`, which includes functions and tests for evaluating spatial patterns and autocorrelation
`r vspace("10px")`
- `tidyverse`, which is a coherent system of packages for data manipulation, exploration and visualization
`r vspace("10px")`
- `ggplot2`, `tmap` and `mapview` for visualization and maps
`r vspace("10px")`
- `SpatialEpi`, which provides methods for spatial epidemiology

---

# Some useful R packages 

Many spatial R packages still depends on the `sp`, thus it is important to know how to convert `sp` to and from `sf` objects

```{r eval=FALSE, echo=TRUE, include=TRUE}
library(spData); library(sf); library(tidyverse)

# world is a sf object containing a world map data
# from Natural Earth with a few variables from World Bank
world <- st_read(system.file("shapes/world.gpkg", package="spData"))
plot(world["pop"])                # plot world population

world_sp <- as(world, "Spatial")  # from sf to sp object
class(world_sp)                   # "SpatialPolygonsDataFrame"

world_sf <- st_as_sf(world_sp)    # from sp to sf object
class(world_sf)                   # "sf"  "data.frame"
```

`r include_fig("World_pop.jpeg", width="30%",title="")`

---

# Some useful R packages 

`sf` works well with the `tidyverse` collection of R packages.

For example, functions can be combined using the pipe operator $\%>\%$ given that both packages are loaded

```{r eval=FALSE, include=TRUE, echo=TRUE}
# Select and plot information for a single attribute
world %>% select(lifeExp) %>% plot()
```

`r include_fig("LifeExp.jpeg", width="50%",title="")`

---

# Some useful R packages 

`sf` object includes spatial metadata like the coordinate reference
system (CRS), which are stored in a list column.

We can extract and plot only the geometry with the function `st_geometry()`

```{r eval=FALSE, include=TRUE, echo=TRUE}
# Extract geometry
worlg_geo <- st_geometry(world)
# Extract and plot out only the geometries
world %>% st_geometry() %>% plot()
```

`r include_fig("World_geom.jpeg", width="50%",title="")`

---


# References

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bibfile,.opts=list(max.names=3))
```
