---
title: "Session 5.1: Hierarchical models: longitudinal data"
params: 
   conference: "Bayesian modelling for Spatial and Spatio-temporal data"
   location: "Imperial College"
   date: ""
   short_title: "MSc in Epidemiology"
output:    
  xaringan::moon_reader: 
    includes: 
       in_header: "../assets/latex_macros.html" 
       # This line adds a logo based on the format selected in the file 'assets/include_logo.html'
       # NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       after_body: "../assets/insert-logo.html"
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "../assets/beamer.css"
---

```{r global_options, echo = FALSE, include = FALSE}
options(width = 999)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      cache = FALSE, tidy = FALSE, size = "small")
```
```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("../assets/setup.R")
library(INLA)

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
#xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
#xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
bibfile=ReadBib("~/Dropbox/Bayes_Spatial_2023/Material/Biblio.bib",check = FALSE)
#bibfile=ReadBib("~/Dropbox/Lavori condivisi/2015_Book/ShortCourse/VIBASS/Biblio.bib",check = FALSE)

```

class: title-slide

# `r rmarkdown::metadata$title``r vspace("10px")` `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

### `r rmarkdown::metadata$params$conference`, `r rmarkdown::metadata$params$location` 

<!-- Can also separate the various components of the extra argument 'params', eg as in 
### `r paste(rmarkdown::metadata$params, collapse=", ")`
-->

`r ifelse(is.null(rmarkdown::metadata$params$date),format(Sys.Date(),"%e %B %Y"),rmarkdown::metadata$params$date)`

---

layout: true  

.my-footer[ 
.alignleft[ 
&nbsp; &copy; Marta Blangiardo | Monica Pirani 
]
.aligncenter[
`r rmarkdown::metadata$params$short_title` 
]
.alignright[
`r rmarkdown::metadata$params$conference`, `r short_date` 
]
] 

```{css,echo=FALSE, eval=FALSE}
.red {
  color: red;
}
.blue {
  color: 0.14 0.34 0.55;
}

.content-box-blue { background-color: #F0F8FF; }

}
```
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>


---

# Learning Objectives

After this session you should be able to:

`r vspace("10px")`

- Specify hierarchical models for longitudinal data

`r vspace("10px")`

- Distinguish between random intercept and random slope models and recognise when each is more appropriate

`r vspace("10px")`

- Be able to run the above models in R-INLA

`r vspace("10px")`


The topics treated in this lecture are covered in Chapter 4 of `r Citet(bibfile, "gomez2020bayesian")`.

---

# Outline

There is huge scope for elaborating the basic hierarchical models
discussed in the previous lecture to reflect additional structure and complexity
in the data, e.g.

`r vspace("10px")`

- Adding covariates at different levels of the hierarchy

`r vspace("10px")`

- Adding further levels to the hierarchy (patients within wards within hospitals, pupils within schools within local authorities, $\ldots$)

`r vspace("10px")`

- Adding non-nested (cross-classified) levels (patients within GPs crossed with hospitals, $\ldots$)

`r vspace("10px")`

- **Repeated observations on some/all units (longitudinal data - we will see it in this lecture)**

`r vspace("10px")`

- Modelling temporal or spatial structure in data, $\ldots$ (we will see it from next week)

`r vspace("10px")`

---

# Outline 

1\. [What are longitudinal data](#longitudinal)

`r vspace("30px")`

2\. [Example: antidepressant clinical trial](#example)

`r vspace("30px")`

3\. [Model specification](#model)

`r vspace("30px")`

4\. [Interpretation](#interpretation)


---

name: longitudinal

`r vspace("250px")`

.myblue[.center[.huge[
**What are longitudinal data**]]]


---

# What are longitudinal data?

- Arise in studies where individual (or units) are measured repeatedly over time

`r vspace("20px")`

- For a given individual, observations over time will be typically dependent

`r vspace("20px")`

- Longitudinal data can arise in various forms:

`r vspace("20px")`

  - continuous or discrete response; discrete response can be binary/binomial, categorical or counts

`r vspace("10px")`
  
  - equally spaced or irregularly spaced

`r vspace("10px")`

  - same or different time points for each individual

`r vspace("10px")`

  - with or without missing data

`r vspace("10px")`

  - many or few time points, $T$

`r vspace("10px")`

  - many or few individuals or units, $n$


---

# Analysing longitudinal data
 
- There are many different ways to analyse longitudinal data

`r vspace("20px")`

- This is a very big field, so we have to be selective

`r vspace("20px")`

-  The key feature of longitudinal data is the need to account for the dependence structure of the data

`r vspace("20px")`

- Two common methods:

  - random effects (hierarchical) models
  `r vspace("10px")`
  - autoregressive models

`r vspace("20px")`

- Here, we will focus on random effects models

---

name: example

`r vspace("250px")`

.myblue[.center[.huge[
**Example: sleep study**]]]


---

# Sleep study

- `r Citet(bibfile, "belenky2003patterns")` describes a study of reaction time in patients under sleep deprivation up to 10 days.

`r vspace("20px")`
- 18 subjects followed for 10 days 
`r vspace("20px")`
- Subjects rated on average reaction time (in ms) for different activities at each measurement
`r vspace("20px")`

```{r eval=TRUE, include=TRUE, echo=TRUE}
library(lme4)
data(sleepstudy)
head(sleepstudy)
```
`r vspace("20px")`

- Reaction time will be rescaled by dividing by 1000 to have the reaction time in seconds
```{r eval=TRUE, include=TRUE, echo=TRUE}
sleepstudy$Reaction <- sleepstudy$Reaction / 1000
```

---

# Sleep Example: data

```{r eval=TRUE, out.width="50%", opts=list(width="50%")}
library(ggplot2)
p <- ggplot(data = sleepstudy, aes(x=Days, y=Reaction, group=Subject))
p + geom_line(aes(colour=factor(Subject)))
```
---

# Sleep Example: objective

- Study objective: is the length of sleep deprivation a determinant of reaction time?
`r vspace("20px")`

- The variables we will use are:
`r vspace("10px")`
  - $y$: Reaction time (in s)
  - $t$: Days

`r vspace("20px")`

- For simplicity we will
`r vspace("10px")`
  - assume a linear relationship
`r vspace("20px")`

- The models we will consider are:
`r vspace("10px")`
  - a non-hierarchical model (standard linear regression) (LM)
  `r vspace("10px")`
  - a hierarchical model with random intercepts (LMM)
  `r vspace("10px")`
  - a hierarchical model with random intercepts and random slopes (LMM2)

---

name: model

`r vspace("250px")`

.myblue[.center[.huge[
**Model specification**]]]


---

# Sleep Example: a Bayesian (non-hierarchical) linear model (LM)

- Specification:
  1\. probability distribution for responses:
$$y_{it} \sim \mbox{Normal}(\mu_{it},\sigma^2)$$

  - $\color{blue}{y_{it}}$ = the reaction time for individual $i$ on day $t$ $(\mbox{days } 0,\ldots,9)$
`r vspace("10px")`
  - linear predictor: $\color{blue}{\mu_{it}}=\alpha+\beta t$
`r vspace("10px")`
  - $\color{blue}{t}$ = the day of the measurement

`r vspace("20px")`

2\. .red[In this model no account is taken of the repeated structure (observations are nested within individuals)]

`r vspace("20px")`

3\. Assume vague priors for all parameters:

\begin{align*}
\alpha, \beta  & \sim  \mbox{Normal}(0,10000)\\
\frac{1}{\sigma^2} & \sim  \mbox{Gamma}(1,0.001)
\end{align*}

---

# Sleep Example: a Bayesian hierarchical linear model

- Modify LM to allow a separate intercept for each individual:

`r vspace("20px")`

\begin{align*}
y_{it} & \sim  \mbox{Normal}(\mu_{it},\sigma^2) \\
\mu_{it}  & =  \textcolor{red}{\alpha_i}+\beta t
\end{align*}

We are assuming that *conditionally* on $\alpha_i$, $\{y_{it}, t=0,\ldots,9 \}$ are independent
`r vspace("10px")`

- Assume that all the $\{\alpha_i\}$ follow a *common* prior distribution, e.g.
$$\color{red}{\alpha_i \sim \mbox{Normal}(\mu_{\alpha}, \sigma^2_{\alpha}) \;\;\;\; i=1,\ldots,246}$$ 

- Here we are assuming exchangeability between all the individuals
- We may then assume vague priors for the *hyperparameters* of the population distribution:

\begin{align*}
\color{red}{\mu_{\alpha}} & \color{red}{\sim  \mbox{Normal}(0,10000)} \\
\color{red}{\frac{1}{\sigma_{\alpha}}} & \color{red}{\sim  \mbox{Gamma}(1,0.001)}
\end{align*}

- This is an example of a *Hierarchical LM* or *Linear Mixed Model (LMM)* or *Random Intercepts* model

---

# Comparing the two models

`r include_fig("DAGS.png", width="80%")`

.pull-left[

(left): LM

]

.pull-right[

(right): LMM - random intercept

]

---

# HAMD example: long vs wide format

- In `R-INLA` is extremely easy to work with longitudinal data, as long as the dataset is in *long format*

.panelset[
.panel[.panel-name[Long format]
```{r eval=TRUE, echo=FALSE}
sleepstudy[1:10,]
```
- Note that a score is present only if the corresponding subject has been observed at that time point
]

.panel[.panel-name[Wide format]

```{r eval=TRUE, echo=FALSE}
reshape(sleepstudy, idvar = "Subject", timevar = "Days", direction = "wide")[1:10,1:6]
```
- Note that with this format should a subject not have measurement for the entire set of days, R would pad these out with NAs 

]
]

---

# Sleep example: `R-INLA` code for LM

.panelset[
.panel[.panel-name[Code]
```{r eval=FALSE, include=TRUE, echo=TRUE,out.width="50%", opts=list(width="50%")}
library(INLA)
formula_LM <- Reaction ~ Days
lm <- inla(formula_LM, data=sleepstudy, family="gaussian", control.compute = list(waic=TRUE))

#Plot
ggplot(data = sleepstudy, aes(x=Days, y=Reaction)) + geom_point(aes(colour = Subject), alpha = .9) + 
  #geom_smooth(method="lm") 
  geom_abline(intercept=lm$summary.fixed[1,1], slope=lm$summary.fixed[2,1]) + labs(title = "Linear Model (LM)")+
  theme(legend.position = "none")
```
]

.panel[.panel-name[Plot]
```{r eval=TRUE, include=TRUE, echo=FALSE,out.width="45%", opts=list(width="45%")}
library(INLA)
formula_LM <- Reaction ~ Days
lm <- inla(formula_LM, data=sleepstudy, family="gaussian", control.compute = list(waic=TRUE))
#Plot
ggplot(data = sleepstudy, aes(x=Days, y=Reaction)) + geom_point(aes(colour = Subject), alpha = .9) + 
  #geom_smooth(method="lm") 
  geom_abline(intercept=lm$summary.fixed[1,1], slope=lm$summary.fixed[2,1]) + labs(title = "Linear Model (LM)")+
  theme(legend.position = "none")

```
- all the subjects share the same intercept and slope
]
]

---

# Sleep example: `R-INLA` code for LMM

.panelset[
.panel[.panel-name[Code]
```{r eval=FALSE, include=TRUE, echo=TRUE}
library(INLA)
formula_LMM <- Reaction ~ Days + f(Subject,model="iid")
lmm <- inla(formula_LMM, data=sleepstudy, family="gaussian", control.compute = list(waic=TRUE))
#Plot
p <- ggplot(data = sleepstudy, aes(x=Days, y=Reaction, group=Subject))
p + geom_point(aes(colour = Subject), alpha = .9) + geom_abline(slope=lmm$summary.fixed[2,1], intercept=lmm$summary.fixed[1,1]+lmm$summary.random$Subject$mean)+ labs(title = "Random Intercept Model (LMM)")+
  theme(legend.position = "none")
```
]

.panel[.panel-name[Plot]
```{r eval=TRUE, include=TRUE, echo=FALSE,out.width="40%", opts=list(width="40%")}
formula_LMM <- Reaction ~ 1 + Days + f(Subject,model="iid")
lmm <- inla(formula_LMM, data=sleepstudy, family="gaussian", control.compute = list(waic=TRUE))

#Plot
p <- ggplot(data = sleepstudy, aes(x=Days, y=Reaction, group=Subject))
p + geom_point(aes(colour = Subject), alpha = .9) + geom_abline(slope=lmm$summary.fixed[2,1], intercept=lmm$summary.fixed[1,1]+lmm$summary.random$Subject$mean)+ labs(title = "Random Intercept Model (LMM)")+
  theme(legend.position = "none")
```
- each individual has a different regression line
- but all individuals have the same slope (parallel lines)

]
]

---

name: interpretation

`r vspace("250px")`

.myblue[.center[.huge[
**Interpretation**]]]

---

# Sleep Example: revisiting the data
.pull-left[
```{r eval=TRUE,out.width="100%", opts=list(width="100%")}
sleepstudy2<- data.frame(Subject=as.factor(unique(sleepstudy$Subject)), intercepts=lmm$summary.random$Subject$mean+lmm$summary.fixed[1,1], slopes=rep(lmm$summary.fixed[2,1],18))
ggplot(data = sleepstudy, aes(x=Days, y=Reaction)) + geom_point() + facet_wrap(~ Subject, ncol=6) +
  geom_smooth(method="lm", se=FALSE) +
  geom_abline(data=sleepstudy2,aes(intercept=intercepts, slope=slopes)) + labs(title = "")+
  theme(legend.position = "none")
```
]

.pull-right[
- .blue[blue]: regression line for each subject; 
- black: regression line from the LMM 
`r vspace("20px")`
- Note that some of the subjects do not fit well in the *parallel lines* scenario 
`r vspace("20px")`
- .red[So we add random slopes to the hierarchical model]
]

---

# Sleep Example: adding random slopes

- Modify LMM to allow a separate slope for each individual:
\begin{align*}
y_{it} & \sim  \mbox{Normal}(\mu_{it},\sigma^2) \\
\mu_{it}  & =  \alpha_i+\color{red}{\beta_{i}}t
\end{align*}

- As for the $\{\alpha_i\}$, assume that the $\{\beta_{i}\}$ follow *common* prior distributions with vague priors on their *hyperparameters*

--

`r vspace("10px")`

- In `R-INLA`

```{r eval=TRUE, echo=TRUE}
Subject2<-sleepstudy$Subject
formula_LMM2 <- Reaction ~ f(Subject, model="iid") + f(Subject2, Days, model="iid")
lmm2 <- inla(formula_LMM2, data=sleepstudy, family="gaussian", control.compute = list(waic=TRUE))
#To access the summaries of the beta_i
lmm2$summary.random$Subject2[1:5,]
```   

---

# HAMD Example: random intercepts and slopes
.pull-left[
```{r eval=TRUE,out.width="100%", opts=list(width="100%")}
sleepstudy2<- data.frame(Subject=as.factor(unique(sleepstudy$Subject)), intercepts=lmm2$summary.random$Subject$mean+lmm2$summary.fixed[1,1], slopes=lmm2$summary.random$Subject2$mean)

ggplot(data = sleepstudy, aes(x=Days, y=Reaction)) + geom_point() + facet_wrap(~ Subject, ncol=6) +
  geom_smooth(method="lm", se=FALSE) +
  geom_abline(data=sleepstudy2,aes(intercept=intercepts, slope=slopes)) + labs(title = "")+
  theme(legend.position = "none")
```
]

.pull-right[
- .red[LMM with random intercepts only:]
  - each individual has a different regression line
  - but for each treatment, only intercept varies by individual

`r vspace("20px")`

- .red[LMM with random intercepts and random slopes:]
  - now intercepts and slopes both vary
  -  better fit for each individual
]

---

# References

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bibfile,.opts=list(max.names=3))
```
