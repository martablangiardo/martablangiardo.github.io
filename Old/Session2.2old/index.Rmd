---
title: "Session 2.2: Spatial models for small area data: disease mapping and ecological regression"
params: 
   conference: "Spatial and Spatio-Temporal Bayesian Models with `R-INLA`"
   location: "University of SÃ£o Paulo"
   date: 27 September 2022
   short_title: "Spatial and Spatio-Temporal Bayesian Models with `R-INLA`"

output:
  xaringan::moon_reader: 
    includes: 
       in_header: "assets/latex_macros.html" 
       # This line adds a logo based on the format selected in the file 'assets/include_logo.html'
       # NB: the actual options (eg placement of the logo and actual logo file) can be changed there
       after_body: "assets/insert-logo.html"
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["https://platform.twitter.com/widgets.js"]
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "assets/beamer.css"
---

```{r echo=F,message=FALSE,warning=FALSE,comment=NA}
# Sources the R file with all the relevant setup and commands
source("assets/setup.R")

# Stuff from 'xaringanExtra' (https://pkg.garrickadenbuie.com/xaringanExtra)
# This allows the use of panels (from 'xaringanExtra')
xaringanExtra::use_panelset()
# This allows to copy code from the slides directly
#xaringanExtra::use_clipboard()
# This freezes the frame for when there's a gif included
#xaringanExtra::use_freezeframe()

# Defines the path to the file with the .bib entries (in case there are references)
bibfile=ReadBib("~/Dropbox/Books/INLABook/ShortCourse/VIBASS/Biblio.bib",check = FALSE)
```

class: title-slide

# `r rmarkdown::metadata$title``r vspace("10px")` `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

### `r rmarkdown::metadata$params$conference`, `r rmarkdown::metadata$params$location` 

<!-- Can also separate the various components of the extra argument 'params', eg as in 
### `r paste(rmarkdown::metadata$params, collapse=", ")`
-->

`r ifelse(is.null(rmarkdown::metadata$params$date),format(Sys.Date(),"%e %B %Y"),rmarkdown::metadata$params$date)`

---

layout: true  

.my-footer[ 
.alignleft[ 
&nbsp; &copy; Marta Blangiardo | Monica Pirani
]
.aligncenter[
`r rmarkdown::metadata$params$short_title` 
]
.alignright[
`r rmarkdown::metadata$params$conference`, `r short_date` 
]
] 

```{css,echo=FALSE, eval=FALSE}
.red {
  color: red;
}
.blue {
  color: 0.14 0.34 0.55;
}

.content-box-blue { background-color: #F0F8FF; }

}
```

---

# Learning Objectives

After this session you should be able to:
   
- Explain the main ideas underlying the use of Bayesian methods for producing spatially smoothed estimates of disease risk in small areas
 
- Describe different priors for spatial random effects 
 
- Explore aetiological hypothesis between a health outcome and exposure based on disease mapping
 
- Describe Poisson regression with spatial random effects for continuous and categorical covariates;

- Use `R-INLA` to produce maps of smoothed estimates of disease risk, carry out spatial smoothing of disease risk and specify ecological regression models 


The topics treated in this lecture are covered in Chapter 5-6 of the book **Spatial and Spatio-Temporal Bayesian models with R-INLA**

---

# Outline 

`r vspace("30px")`

1\. [Spatial Structure](#spatial-structure)

`r vspace("30px")`

2\. [Example: suicides in London](#Example)

`r vspace("30px")`

3\. [Ecological regression with spatial random effects](#Poisson-regression)

---


# Smoothed estimates of the RR (non spatial)

- Poisson-logNormal model based on the assumption that the observations in the data set are identically distributed and independent

`r vspace("20px")`

- However, data that occur close together in space (or time) are likely to be correlated    
  .red[&rarr; Dependence between observations is a more realistic assumption]

`r vspace("20px")`

- Ignoring this dependence can lead to biased and inefficient inference    
  .red[&rarr; Smooth in space] prior distribution for the random effects should allow for spatial correlation

---

name: spatial-structure
  
`r vspace("250px")`

.myblue[.center[.huge[
**Spatial structure**]]]

---

# Intrinsic CAR model `r Cite(bibfile, "Besag:1991")`

- Specify the distribution of each random effect as if we knew the values of the spatial random effects in .red[neighbouring areas]

`r vspace("20px")`

- We have a conditional specification since we are conditioning on knowing the neighbours

`r vspace("20px")`

- Rule for determining the neighbours of each area: most common based on common boundary

`r vspace("20px")`

- Use of conditional autoregressive distributions

.panelset[
.panel[.panel-name[General definition]

$$\mathbf{u} \sim \hbox{ICAR}(\mathbf{W},\sigma^2_u)$$

with

`r vspace("20px")` 
- $\mathbf{W}$ matrix defining the neighbours (weights)
- $\sigma^2_u$ conditional variance parameter of $\mathbf{U}$

$$u_i \mid u_{j \;\; j\ne i} \sim \hbox{Normal}\left(\frac{\sum_{j} W_{ij} u_j}{\sum_{j} W_{ij}}, \frac{\sigma^2_u}{\sum_{j}  W_{ij}}\right)$$
]

.panel[.panel-name[Common definition]

$$\mathbf{u} \sim \hbox{ICAR}(\mathbf{W},\sigma^2_u)$$

Let $\partial_i =$ set of areas adjacent to $i$, $w_{ij}$  = 1 for $j \in \partial_i$, 0 otherwise
$$u_i \mid u_{j \;\; j\ne i} \sim \hbox{Normal}\left(\frac{\sum_{j \in \partial_i} u_j}{n_i}, \frac{\sigma^2_u}{n_i}\right)$$

`r vspace("20px")`

- $u_i$ is smoothed towards mean risk in a set of neighbouring areas
- Conditional variance inversely proportional to the number of neighbours (so more neighbours, less variability)

]

.panel[.panel-name[Remarks]
- ICAR model is improper: the overall mean of the $\bm{u}$ is not defined. So an additional constraints needs to be imposed:
.red[**sum-to-zero constraint**:]  $\sum_i u_i  = 0$

`r vspace("20px")`  

- The parameter $\sigma^2_u$ represents the .red[**conditional**] variance of the random effects (and not the marginal one) and its magnitude determines the amount of spatial variation

`r vspace("20px")`

- No closed-form expression available for the .red[**marginal**] between-area variance of the spatial effects 
  &rarr; estimate marginal spatial variance empirically
$$s^2_{\text{u.marginal}} = \sum_i (u_i - \overline{u})^2 / (N-1)$$
]
]

---

#Combining ICAR with unstructured random effects
- ICAR model makes a strong spatial assumption; it cannot take a limiting form that allows non-spatial variability

- Besag, York and Mollie (BYM) recommended combining the ICAR prior and the standard normal prior to allow for both     
  - spatially unstructured latent covariates $\bm{v}$ modelled as iid
  &rarr; global smoothing
  - spatially correlated latent covariates $\bm{u}$ modelled as ICAR
  &rarr; local smoothing
  
.panelset[
.panel[.panel-name[BYM]
\begin{align*}
y_i &\sim \text{Poisson}(\lambda_i = \rho_i E_i)\\
\eta_i &= \log \rho_i = b_0 + v_i + u_i\\
v_i &\sim \text{Normal}(0, \sigma^2_v)\\
\mathbf{u} &\sim \hbox{ICAR}(\mathbf{W},\sigma^2_u)
\end{align*}

- Need to specify hyperprior distributions for:

- $\sigma^2_v$ (between-area unstructured marginal variance), e.g. $1/\sigma^2_v \sim \text{Gamma}(1,0.001)$
- $\sigma^2_u$ (between-area spatial conditional variance), e.g. $1/\sigma^2_u \sim \text{Gamma}(1,0.001)$
- $b_0$ (mean log relative risk), e.g. $b_0 \sim \text{Normal}(0,0.0001)$ 
]

.panel[.panel-name[BYM2]

\begin{align*}
y_i &\sim \text{Poisson}(\lambda_i = \rho_i E_i)\\
\eta_i &= \log \rho_i = b_0 + b_i\\
\boldsymbol{b} &= \frac{1}{\sqrt{\tau_b}}(\sqrt{1-\phi}\boldsymbol{v}_{*} + \sqrt{\phi}\boldsymbol{u}_{*})
\end{align*}

where $\boldsymbol{v}_{*}$ and $\boldsymbol{u}_{*}$ are standardised versions of $\bm{u}$ and $\bm{v}$. 

- Need to specify hyperprior distributions for:

- $\phi$ which is the weight of the spatially structured residual
- $\tau_b$ which is the marginal variance of the random effect 
]
]

---

# Priors for BYM2
    
Under the BYM2 specification the hyperparameters $\tau_b$ and $\phi$ are modelled using .red[**Penalised Complexity** (PC) priors] `r Cite(bibfile,"10.1214/16-STS576")`

- Regularise inference while not forcing too strong information

- Penalise departure from a "base" model (eg parameter = some fixed value)

- Prior tends to favour the base model &rarr; need fairly strong evidence to move away from it

- Distance between the **base** model $\color{red}g(\xi)$ and an **alternative**, more complex model $\color{blue}f(\xi)$ is measured by
  
.blue[
$$d(f,g) = \sqrt{2\kld(f,g)} \qquad {\style{font-family:inherit; font-size: 105%; color: black;}{\text{with}}} \qquad \kld(f,g) = \int f(\xi)\log\left(\frac{f(\xi)}{g(\xi)}\right)d\xi$$
]

--

- Penalisation done at a constant rate 

.blue[   
$$p(d)=\lambda\exp(-\lambda d)\sim \dexp(\lambda) \qquad {\color{black}\Rightarrow} \qquad p(\xi)=\lambda e^{-\lambda d(\xi)}\left\lvert \frac{\partial d(\xi)}{\partial \xi} \right\rvert$$
]

- PC prior defined using probability statements on the model parameters (in the appropriate scale) to determine the value of $\lambda$ using "reasonable" information

---

# Priors for BYM2

Using probability statements we can define the PC priors for the two hyperparameters as:
`r vspace("-10px")`
.pull-left[
.content-box-beamer[
### Prior on $\tau_b$

$$P((1/\sqrt{\tau_b})>U_1) = \alpha_1$$

which can be interpreted as .blue[*the probability that the standard deviation of the random effect is larger than*] $\class{blue}{U_1}$ .blue[*is equal to*] $\class{blue}{\alpha_1}$
]
]

.pull-right[
.content-box-beamer[
### Prior on $\phi$

$$P(\phi < U_2) = \alpha_2$$

which can be interpreted as .blue[*the probability that the spatial random effect explains less than*] $\class{blue}{U_2}$ .blue[*of the total variability is equal to*] $\class{blue}{\alpha_2}$
]
]

---
count: false
# Priors for BYM2

Using probability statements we can define the PC priors for the two hyperparameters as:
`r vspace("-10px")`
.pull-left[
.content-box-beamer[
### Prior on $\tau_b$

$$P((1/\sqrt{\tau_b})>U_1) = \alpha_1$$

which can be interpreted as .blue[*the probability that the standard deviation of the random effect is larger than*] $\class{blue}{U_1}$ .blue[*is equal to*] $\class{blue}{\alpha_1}$
]
]

.pull-right[
.content-box-beamer[
### Prior on $\phi$

$$P(\phi < U_2) = \alpha_2$$

which can be interpreted as .blue[*the probability that the spatial random effect explains less than*] $\class{blue}{U_2}$ .blue[*of the total variability is equal to*] $\class{blue}{\alpha_2}$
]
]

`r vspace("5px")`

where $\lambda = \frac{-\log(\alpha_k)}{U_k}$



- We need to define $U_1, U_2$ and $\alpha_1, \alpha_2$ and following `r Citet(bibfile, "10.1214/16-STS576")`:
`r vspace("10px")`

--

  - A marginal sd not too large (e.g. 0.5);

--

  - $\alpha_1=0.01$ (we want to allow for a small probability)

--

  - $\alpha_2=2/3$ (we expect a higher probability that the variability to be explained by the spatial random effect is lower than 50%)

--

- Then 

    1\. Assuming $U_1=0.5/0.31$ translates into $P(\sigma_{\tau_b}>1.62) = 0.01$, using the rule of thumb in `r Citet(bibfile, "10.1214/16-STS576")`
    
    2\. Assuming $U_2=0.5$ we get $P(\phi < 0.5) = 2/3$

---

# Poisson model with BYM random effects 

- Choice of the adjacency matrix (neighbours): 2 areas are neighbours if they share a common border

  &rarr; Adjacency matrix implemented in INLA     

- An area cannot be specified as its own neighbour

- Adjacency matrix must be symmetric

--

- $\text{RR}_i = \exp(b_0 + b_i)$: RR in area $i$ relative to the age/sex structure (used to estimate the $E_i$)

- $\hbox{residual RR}_i = \exp(b_i)$: residual RR in area $i$ relative to the region average after adjusting for the overall risk

--

- $\sigma^2_b$ reflects the marginal variability of the REs 

- $\phi$ represent the weight of the spatial structure

---

name: Example
  
`r vspace("250px")`

.myblue[.center[.huge[
**Example: Suicides in London**]]]

---

# Suicides in Greater London, M+F, 1989-1993, Boroughs

- 32 boroughs in Greater London

- Interest: mapping the RR in each borough

- Methods with no spatial structure: SMR, non spatial smoothing

- Spatial smoothing using the BYM model

\begin{align*}
y_i & \sim  \hbox{Poisson}(\rho_i E_i)\\
\log \rho_i  & =  b_0 + b_i\\
v_i &\sim  \hbox{Normal}(0, \sigma^2_v)\\
\bm{u} & \sim  \hbox{ICAR}(\mathbf{W}, \sigma^2_u)
\end{align*}

- Data: $\bm{y}$ and $\bm{E}$
- Priors: $\sigma^2_v$, $\sigma^2_u$, $b_0$
- Parameters of interest: 
  - residual RR $(\hbox{resRR}_i=\exp(b_i))$
  - marginal variance $(1/ \tau_b)$
  - percent of total variation in the log RR due to spatial effects $(\phi)$
  
---

# Adjacency matrix in INLA
    
- It is possible to produces a graph from a shapefile

`r vspace("20px")`

- Upload the shapefile using `sf` package

```{r read_shp, echo=TRUE, include=TRUE,eval=FALSE}
library(sf)
london.gen <- read_sf("LDNSuicides.shp")
london.gen$ID <- seq(1,32)

```

```{r read_shp1, echo=TRUE, include=FALSE,eval=TRUE}
library(sf)
london.gen <- read_sf("~/Dropbox/Books/INLABook/ShortCourse/VIBASS/Datasets/LDN/LDNSuicides.shp")
london.gen$ID <- seq(1,32)
```

--

- Use `poly2nb` and `nb2INLA` from the `spdep` package to transform the shapefile into adjacency matrix

```{r spdep, echo=TRUE, include=TRUE,eval=FALSE}
library(spdep)
nb2INLA("LDN.graph",poly2nb(london.gen))
LDN.adj <- paste(getwd(),"/LDN.graph",sep="")
```
  
--

- Now `LDN.graph` has been saved in the working directory and can be called when specifying the BYM model (see later)

---

# Spatial distributions for area level data in INLA

We introduce here the specification of the `ICAR` and `BYM2` models in `INLA`, which are done through `f()`:

.panelset[
.panel[.panel-name[ICAR in `INLA`]
```{r xx, echo=TRUE, eval=FALSE}
formula.ICAR <- y ~ f(ID, model="besag", graph=LDN.adj)	
```
             
`r vspace("20px")`

- `ID` is the area identifier

`r vspace("20px")`

- `graph=LDN.adj` identifies the adjacency structure constructed as seen before

`r vspace("20px")`

- `model=besag` specifies the intrinsic conditional autoregressive structure as described before

On the example:

```{r suicides-besag, echo=TRUE, eval=FALSE}
formula <- y ~ 1 + f(ID, model="besag",graph=LDN.adj, 
                    hyper=list(
                      prec=list(
                        prior="loggamma",param=c(1,0.0005))))
```
]

.panel[.panel-name[BYM2 in `INLA`]
```{r xxx, echo=TRUE, eval=FALSE}
formula.BYM2 <- y ~ f(ID, model="bym2", graph=LDN.adj)	
```

`r vspace("20px")`

- `ID` is the area identifier

`r vspace("20px")`

- `graph=LDN.adj` identifies the adjacency structure constructed as seen before

`r vspace("20px")`

- `model=BYM2` specifies the combination of the intrinsic conditional autoregressive structure and unstructured random effect as described before

On the example:

```{r suicides-bym, echo=TRUE, eval=FALSE}
formula <- y ~ 1 + f(ID, model="bym2",graph="LDN.graph", 
        hyper=list(prec = list(
        prior = "pc.prec",
        param = c(0.5 / 0.31, 0.01)),
        phi = list(
        prior = "pc",
        param = c(0.5, 2 / 3))))
```
]
]

---

# Running the model in `INLA`

```{r code_suicides, echo=TRUE, eval=TRUE, include=FALSE}
load("~/Dropbox/Books/INLABook/ShortCourse/VIBASS/Datasets/LDN/LondonSuicides.RData")
library(INLA)
datasuicides<-tibble(y=y,E=E, ID=seq(1,32))
Nareas <- 32
formula <- y ~ 1 + f(ID, model="bym2",graph="~/Dropbox/Books/INLABook/ShortCourse/VIBASS/Datasets/LDN/LDN.graph", 
        hyper=list(prec = list(
        prior = "pc.prec",
        param = c(0.5 / 0.31, 0.01)),
        phi = list(
        prior = "pc",
        param = c(0.5, 2 / 3))))

mod.suicides <- inla(formula,family="poisson",
                       E=E,data=datasuicides,
                       control.compute=list(dic=TRUE))
```
To run the model in INLA
```{r running, echo=TRUE, eval=FALSE}
mod.suicides <- inla(formula,family="poisson",
                       data=data.suicides,E=E,
                       control.compute=list(dic=TRUE, waic=TRUE))
```

`R-INLA` estimates the parameters $\bm \theta = \{b_0, \bm{b}, \bm{u}\}$ and the hyper-parameters  $\bm\psi=\{\tau_{b}, \phi\}$.

---

# How to get information from random effects
 
- The random effect are obtained through 

```{r raneff, echo=TRUE, eval=FALSE, include=TRUE}
mod.suicides$summary.random$ID

```

```{r raneff1, echo=FALSE, eval=TRUE, include=TRUE}
head(mod.suicides$summary.random$ID)

```

which is a matrix formed by $2n$ rows: 

  - $1:n$ rows include information on the area specific residuals $b_i$
  - $n+1:2n$ rows are the spatially structured residual $u_i$

---

# How to get information from random effects
 
- All these parameters are on the logarithmic scale; to transform the **marginal** back to the natural scale:
.pull-left[
```{r trans, echo=TRUE, eval=TRUE}
b <- mod.suicides$marginals.random$ID[1:Nareas]
```
this returns a list with `Nareas` number of elements, each representing the posterior marginal of $b_i$ for that area
]

.pull-right[
```{r fig2.1, echo=FALSE, out.width="50%", opts=list(width="50%")}
plot(b[[1]],type="l", cex.lab=1.5)
```
]

--
`r vspace("20px")`

- Then we can get the posterior mean and 95% credible intervals:

.pull-left[
```{r trans1, echo=TRUE, eval=TRUE, include=TRUE}
zeta <- lapply(b,function(x) inla.emarginal(exp,x))
zeta_CI <- lapply(b,function(x) 
inla.qmarginal(c(0.025,0.975),
    inla.tmarginal(exp,x)))
```
]

.pull-right[
```{r trans1-CI, echo=FALSE, eval=TRUE, include=FALSE}
#CI <- tibble(mean=unlist(zeta),CI2.5=unlist(zeta_CI)[seq(1,64,2)],CI97.5=unlist(zeta_CI)[seq(2,64,2)], ID=datasuicides$ID)
#ggplot(CI, aes(x=ID,y=mean)) + geom_point() + 
#  geom_hline(yintercept=1,linetype="dashed") + 
#  geom_errorbar(aes(ymin=CI2.5, ymax=CI97.5), width=.1) 
```

`r vspace("-150px")`

`r include_fig("trans1-plot-1.png",width="50%",title="")`
]

---

# Identification of spatial patterns
 
- What is the sensitivity vs specificity of smoothed RR?
  - Ability to detect true patterns (sensitivity)
  - Ability to discard false patterns (specificity)

`r vspace("10px")`

- Detection of increased/decreased RR 

  &rarr; Posterior probabilities that the residual RR is above/below 1 `r Cite(bibfile,"Richardson:2004")`

`r vspace("10px")`

- Area with an increased risk
\begin{align*}
\hbox{P(resRR}_i>1)>0.8 & \Leftrightarrow \hbox{P}(e^{(u_i+v_i)}>1)>0.8\\
& \Leftrightarrow  \hbox{P}(u_i+v_i>0)>0.8
\end{align*}
  
- Area with a decreased risk
\begin{align*}
\hbox{P(resRR}_i<1)>0.8 & \Leftrightarrow  \hbox{P}(e^{(u_i+v_i)}>1)<0.2\\
& \Leftrightarrow  \hbox{P}(u_i+v_i>0)<0.2
\end{align*}
     
---
    
# Posterior probability in INLA
     
- Remember the parametrisation $\zeta = \exp{(b_i)}$
      
- We can visualize $p(\zeta_i>1\mid \bm y)=p(b_i>0\mid \bm y)$ using the built-in function `inla.pmarginal`:
```{r postprob, echo=TRUE,eval=TRUE}
a <- 0
prob.b <- lapply(b, function(x) {1 - inla.pmarginal(a, x)})
```

--

- Create an object with all the info to map
```{r map-prep,echo=TRUE}
RR_BYM <- tibble(zeta=unlist(zeta),prob=unlist(prob.b), ID=seq(1,32))
out_map <- left_join(london.gen,datasuicides, by="ID") %>% left_join(., RR_BYM, by="ID")
out_map$pp_breaks <- cut(out_map$prob, 
                           breaks = c(0, c(0.2, 0.8), 
                                      1), include.lowest = T)
```

---

#...and then create some maps

.pull-left[
### Map of posterior mean of $b_i$
```{r map-post-mean,echo=TRUE}
ggplot() + geom_sf(data = out_map, 
                   aes(fill = zeta)) + 
            scale_fill_viridis_c()
```
]

.pull-right[
### Map of posterior probability of $b_i>0$
```{r map-post-p,echo=TRUE}
ggplot() + geom_sf(data = out_map, 
           aes(fill = pp_breaks)) + 
  scale_fill_manual(values = c("blue","orange","red"))
```
]

---

# Output from different models

.panelset[
.panel[.panel-name[Comparing maps]     
.pull-left[
- **SMR** non smoothed RR
                 
- **HET** non spatially smoothed residual RR: $\exp(v)$
                   
- **CAR** spatially smoothed residual RR: $\exp(u)$
                   
- **BYM** spatially and non spatially smoothed residual RR: $\exp(b)=\exp(u+v)$
]
.pull-right[
`r include_fig("Lungmales_4maps.jpg",width="90%",title="")`
]
]

.panel[.panel-name[Shrinkage]
.pull-left[  
`r include_fig("Lungmales_shrinkage.jpg",width="90%",title="")`
]

.pull-right[
- Shrinkage towards the mean due to the **borrowing of strength**
]
]

.panel[.panel-name[Interpretation]

- Smoothed relative risks are more stable (precise than observed)

&rarr; geographical patterns of risk are easier to detect using smoothed maps

`r vspace("10px")`

- Smoothed relative risks have higher specificity:
  - Possible "false positive" values shrunk towards mean
  - But in danger of over-smoothing (false negatives)

`r vspace("10px")`

- Visual impact of maps can be very dependent on the choice of colours and cut-points used to shade each region

&rarr; Care must be taken not to over-interpret any patterns identified

]
]
---

name: Poisson-regression
  
`r vspace("250px")`

.myblue[.center[.huge[
**Ecological regression with spatial random effects**]]]

---
# Disease Mapping vs Ecological Regression
       
## Disease mapping studies
       
- Focus is on description
- Level of inference is at the aggregate (small area) level
       
      
## Ecological correlation studies
       
- Focus is on **explanation**
  
  - Used for investigating specific exposure-disease hypotheses at small-area scale

  - Poisson regression can be used to model relationship between any area-level exposure measure and incidence/prevalence of disease

  - Such area-level exposure measures include average annual pollution level, proportion of population who smoke, proportion of population living with x km of a landfill site, etc.
 
---

# Poisson regression with random effects

Straightforward extension of disease mapping model:

.content-box-beamer[
### Ecological regression with BYM structure
  
\begin{align*}
\hbox{y}_i & \sim  \hbox{Poisson}(E_i \rho_i); \;\;\; i=1,...,N\\
\log \rho_i & =  b_0 + \class{red}{\beta_1 x_i} + u_i + v_i\\
\text{residual RR}_i &= \exp(b_i) = \exp(u_i + v_i)\\
\boldsymbol{b} &= \frac{1}{\sqrt{\tau_b}}(\sqrt{1-\phi}\boldsymbol{v}_{*} + \sqrt{\phi} \boldsymbol{u}_{*})\\ 
v_i &\sim \text{Normal}(0, \sigma^2_v) \;\;\; \mathbf{u} \sim \hbox{ICAR}(\mathbf{W},\sigma^2_u)
\end{align*}
]

`r vspace("20px")`

where
 
- $O_i$ and $E_i$: Observed and expected nb of cases in each area $i$
- $\lambda_i$: unknown RR
- $x$  area-level covariate of interest
- $\beta_1$: parameter associated with the covariate
- $\bm v_{*}$: standardised version of unstructured random effects, i.i.d.
- $\bm u_{*}$: standardised version of random effects with spatial structure, conditional distribution


---
  
# Interpretation of the parameters

- $\exp(\beta_1)$ is the change in risk associated with a unit
   change in exposure $x$
   
`r vspace("30px")`
   
- $b_i$ is the  random effect in area $i$

`r vspace("30px")`

- $\exp(b_i)$ is the residual or adjusted relative risk of disease
   in area $i$ .blue[after accounting for the effects of measured covariates and the
   overall mean risk]

`r vspace("30px")`

- The variance of the random effects reflects the amount of overdispersion
   in the data (total residual variance = Poisson variance + random effects variance)
 
---
# Poisson regression with random effects - INLA code

- Continuous covariate
```{r ecoreg, echo=TRUE, eval=FALSE}
formula.ecoreg.inla <- y ~ 1 + x +
        f(id,model="bym", graph=graph,                 
          hyper=list(prec.spatial=list(
                prior="loggamma",param=c(0.01,0.01))))
```

  - Categorical covariate
```{r ecoreg2, echo=TRUE, eval=FALSE}
formula.ecoreg.inla <- y ~ 1 + cut(x,breaks=c(0,7,10,24),
                           include.lowest=TRUE) +
                           f(id,model="bym", graph=graph,   
                             hyper=list(prec.spatial=list(
                             prior="loggamma",param=c(0.01,0.01))))
```

---

# Comparison between DM and ecological regression

`r vspace("-40px")`

`r include_fig("LipCancer.png", width="50%",title="")`

`r vspace("-40px")`

- Less extreme values when covariates are included

&rarr; part of the spatial variability is explained by the covariates
---
# Poisson regression with random effects

.content-box-beamer[

### Extension to several variables

\begin{align*}
\hbox{y}_i & \sim  \hbox{Poisson}(E_i \rho_i); \;\;\; i=1,...,N\\
\log \rho_i & =  b_0 + \beta_1 x_{1i} +\beta_2 x_{2i} + b_i\\
& ...
\end{align*}
]

`r vspace("10px")`

- $\exp(\beta_1)$ is the relative risk of disease/death associated with a unit
   increase in exposure $x_1$, after adjustment for $x_2$
   
`r vspace("10px")`

- $\exp(\beta_2)$ is the relative risk of disease/death associated with a unit
   increase in exposure $x_2$, after adjustment for $x_1$

`r vspace("10px")`

- $\exp(b_i)$ is the residual or adjusted relative risk of disease/death
   in area $i$ after accounting for the effects of measured covariates and the overall mean risk
 
---
     
 # Summary
  
- Hierarchical models allow "borrowing of strength" across units
 
  - posterior distribution of $\rho_i$ for each unit borrows
   strength from the likelihood contributions for
   **all** the units, via their joint influence on the posterior
   estimates of the unknown hyper-parameters
 
`r vspace("10px")`
 
- Judgements of exchangeability need careful assessment
 
  - units suspected a priori to be systematically different might be modelled by including relevant covariates so that residual variability more plausibly reflects exchangeability
  - subgroups of prior interest should be considered separately

`r vspace("10px")`

- Mapping geographical variations in disease risk is an important epidemiological technique for
   suggesting aetiological hypotheses

`r vspace("10px")`

- When combined with data on geographical variations in exposure, disease mapping techniques can be used to investigate and quantify **ecological** associations between disease risk and potential exposures

---

# References

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bibfile,.opts=list(max.names=3))
```
