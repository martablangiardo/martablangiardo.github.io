---
title: "Session 8.1: Introduction to Geostatistics"
params: 
   conference: "Bayesian modelling for Spatial and Spatio-temporal data"
   location: "Imperial College London"
   date: ""
   short_title: "MSc Epidemiology"
output:
   xaringan::moon_reader: 
    includes: 
       # This line adds a logo based on the format selected in the file 'assets/include_logo.html'
       in_header: "assets/latex_macros.html" 
       # NB: the actual options (eg placement of the logo and actual logo file) can be changed there
     #  after_body: "assets/insert-logo.html" # Monica commented this
    seal: false
    yolo: no
    lib_dir: libs
    nature:
      beforeInit: ["assets/remark-zoom.js","https://platform.twitter.com/widgets.js"]
      navigation:
        scroll: false # disable slide transitions by scrolling
      highlightStyle: github
      highlightLines: yes
      countIncrementalSlides: no
      ratio: '16:9'
      titleSlideClass:
      - center
      - middle
    self_contained: false 
    css:
    - "assets/beamer.css"
editor_options: 
  chunk_output_type: console
---

```{r global_options, echo = FALSE, include = FALSE}
options(width = 999)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      cache = FALSE, tidy = FALSE, size = "small")
#options(htmltools.preserve.raw = FALSE)
# https://stackoverflow.com/questions/65766516/xaringan-presentation-not-displaying-html-widgets-even-when-knitting-provided-t
```

```{r echo=F, message=FALSE, warning=FALSE, comment=NA}
source("assets/setup.R")
library(INLA)
xaringanExtra::use_panelset()
bibfile=RefManageR::ReadBib("~/Dropbox/TEACHING/YEAR_2023/Advanced_Analytics_2023/Material/Session3.1/Biblio.bib",check = FALSE)
```

class: title-slide

# `r rmarkdown::metadata$title``r vspace("10px")` `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$author`

### `r rmarkdown::metadata$institute`    

### `r rmarkdown::metadata$params$conference`, `r rmarkdown::metadata$params$location` 

<!-- Can also separate the various components of the extra argument 'params', eg as in 
### `r paste(rmarkdown::metadata$params, collapse=", ")`
-->

`r ifelse(is.null(rmarkdown::metadata$params$date),format(Sys.Date(),"%e %B %Y"),rmarkdown::metadata$params$date)`

---

layout: true  

.my-footer[ 
.alignleft[ 
&nbsp; &copy; Marta Blangiardo | Monica Pirani
]
.aligncenter[
`r rmarkdown::metadata$params$short_title` 
]
.alignright[
`r rmarkdown::metadata$params$conference`, `r short_date` 
]
] 

```{css,echo=FALSE, eval=FALSE}
.red {
  color: red;
}
.blue {
  color: 0.14 0.34 0.55;
}

.content-box-blue { background-color: #F0F8FF; }

}
```

```{css, echo=FALSE}
.scrollable {
  height: 80%;
  overflow-y: auto;
} 
```
---

# Learning Objectives

At the end of this session you should be able to:

`r vspace("20px")`

- know the common models used for **geostatistical data** analysis, i.e. Gaussian fields (GF);

`r vspace("20px")`


- understand the assumptions of stationarity and isotropy; 


`r vspace("20px")`

- understand the variogram and semivariogram.

`r vspace("30px")`

The topics treated in this lecture can be found in:

- Section 6.4 of the book **Spatial and Spatio-Temporal Bayesian models with R-INLA**

- Chapter 8 of the book **Geospatial Health Data: Modeling and Visualization with R-INLA and Shiny**  https://www.paulamoraga.com/book-geospatial/index.html


---

# Outline 

`r vspace("30px")`

1\. [Introduction to spatial modeling for geostatistical data (based on GF)](#introduction)

`r vspace("30px")`

2\. [Assumptions of stationarity and isotropy](#stationarity)

`r vspace("30px")`

3\. [The variogram and semivariogram](#vario)

---

name: introduction
  
`r vspace("250px")`

.myblue[.center[.huge[
**Introduction to spatial modeling for geostatistical data (based on GF)**]]]

---

# Geostatistical data

.panelset[
.panel[.panel-name[Definition]
- The difference between models for .red[**geostatistical**] (or point referenced) data and the spatial models presented in week 7 is that here we treat space as continuous,
not discretised (areas).

`r vspace("20px")`

- We are concerned here with spatial data structures where the
process of interest (response) is a spatial field 
$$\{Z(\mathbf{s}): \mathbf{s} \in \mathcal{D} \}$$
i.e. real values stochastic process characterized by a spatial index $\bm{s}$ which varies .red[**continuously**] in the fixed domain $\mathcal D$.

`r vspace("20px")`

-  Data are measured (possibly with error) at $n$ spatial locations $(\bm{s}_{1},\ldots,\bm{s}_{n})$ and are denoted by $\bm{Z}=\left(Z(\bm{s}_1),\ldots, Z(\bm{s}_n)\right)=(Z_1,\ldots,Z_n)$.


]

.panel[.panel-name[Example]
.pull-left[
`r vspace("20px")`
- Examples: 
`r vspace("20px")`
  - in environmental science: rainfall, air pollution concentrations, radioactive emission in soil, etc.
  `r vspace("10px")`
  - in epidemiology: prevalence of a disease measured at different villages distributed over a region of interest.
  `r vspace("10px")` 
  - in ecology: density of mosquitoes responsible for disease transmission measured using traps placed at different locations.
]

.pull-right[
```{r meusezinc,echo=F, out.width="100%", fig.dim=c(10,6)}
library(sp)
library(mapview)
library(sf)
data(meuse, package = "sp")
meuse = st_as_sf(meuse, coords = c("x", "y"), crs = 28992, agr = "constant")

mapview(meuse,
        xcol = "Longitude",
        ycol = "Latitude",
        zcol = "zinc") 
```
]
]
]
---

# Aims

- To **reconstruct the spatial field** from a  finite set of **noisy** observations taken at a finite number of spatial locations.

`r vspace("20px")`

- To use the spatial dependence to **predict values** of the spatial field
(together with associated uncertainty) at locations where there are
no observations.

`r vspace("30px")`

- Example: Each point represents a weather station in Brazil, and we have an
associated $Z(s)$, which is air temperature.

`r vspace("20px")`

 - Using geostatistical methods we can reconstruct a latent spatial field from the finite set of
observations taken at a finite number of spatial locations

`r include_fig("Brazil.jpg",width="43%",title="")`
---

# Gaussian fields

- The common methodological framework to geostatistical models is that of .red[**Gaussian  fields** (or processes)], which are based on the multivariate Normal  distribution.

`r vspace("21px")`

- A spatial process $Z(\bm{s})$ is a .red[**Gaussian field**] (GF) if for any $n \geq 1$ and for each set of locations $(\bm{s}_{1},\ldots,\bm{s}_{n})$, the vector $(Z(\bm{s}_1),\ldots, Z(\bm{s}_n))$ follows a .red[multivariate Normal distribution] with mean $\bm{\mu}=(\mu(\bm{s}_{1}), \ldots, \mu(\bm{s}_{n}))$ and spatially structured covariance matrix $\bm{\Sigma}$.

`r vspace("21px")`

- The  generic element of $\bm{\Sigma}$ is defined by a  **spatial covariance function** $\mathcal C(\cdot,\cdot)$
 such that $\Sigma_{ij}=\mbox{Cov}\left(Z(\bm{s}_{i}),Z(\bm{s}_{j})\right)=\mathcal C(Z(\bm{s}_{i}),Z(\bm{s}_{j}))$.


---

name: stationarity
  
`r vspace("250px")`

.myblue[.center[.huge[
**Stationarity and Isotropy**]]]


---

# Stationarity 

- An important concept is geostatistical data analysis is given by .red[stationary], that refers to the stability (i.e. equilibrium) of the statistical properties of spatial process.

`r vspace("20px")`

- In simple terms, stationarity means that the random field (i.e. spatial process) looks similar in different parts of the domain.

`r vspace("20px")`

- We are going to explore different degrees of stationarity:
 - Strict (or strong) stationarity
 - Weak (or second-order) stationarity
 - Intrinsic stationarity

---

# Strict (or strong) stationarity

- The spatial process (or random process) is called .red[**strict (or strong) stationary**] if it is invariant under translation of the coordinates (i.e. invariant to shifts in space).


- In particular, for any set of locations $\mathbf{s}_i$, $i=1,\dots,N$ and any displacement, $\mathbf{h}\in \mathbb{R}^{2}$, the distribution of $\{Z(\mathbf{s}_1),\dots, Z(\mathbf{s}_N\}$ is the same as that of $\{Z(\mathbf{s}_{1}+\mathbf{h}),\dots, Z(\mathbf{s}_{N}+\mathbf{h})\}$.


- A strictly stationary random field repeats itself throughout the domain.


`r vspace("30px")`

Note that here $\mathbf{h}$ refers to the spatial separation of the locations (i.e. the lag-vector: $\mathbf{s}_i - \mathbf{s}_j$).

---

# Weak (or second-order) stationarity and Isotropy

- The spatial process (or random process) is called .red[**weak (or second-order) stationary**] if
`r vspace("10px")`
  - $\bm{\mu}$  is constant (i.e., $\mu(\bm{s}_{i}) = \mu$ for each $i$) 
`r vspace("10px")`
  - the spatial covariance function depends only on the distance vector $(\bm{s}_{i}-\bm{s}_{j}) \in \mathbb{R}^2$, i.e. $\mbox{Cov}\left(Z(\bm{s}_{i}),Z(\bm{s}_{j})\right)=\mathcal C(\bm{s}_{i}-\bm{s}_{j})$ 

`r vspace("20px")`
  
--

- Moreover, a second-order stationary spatial process is .red[**isotropic**] if the covariance does not depend on the direction but just on the Euclidean distance  $||\bm{s}_{i}-\bm{s}_{j}||$ (where $\| \cdot \|$ denotes the Euclidean norm, i.e. Euclidean distance)

`r vspace("20px")`

- In other words, the covariance depends only on the distance between two points irrespective of the geographical direction (north-south or east-west) of one from the other

`r vspace("20px")`

- When covariance functions exhibit different behavior in different directions, the random fields are called .red[anisotropic]

---

# Intrinsic stationarity

- .read[Intrinsic stationarity] is a relaxed form of stationarity, which
is based on the difference in the process between locations

- In particular, for a choice of two locations, we assume that
the difference in means will be zero (i.e. constant mean assumption) and the difference in variance is defined as:

$$Var(Z(\mathbf{s+h})-Z(\mathbf{s})) = 2\gamma(\mathbf{h})$$
- The function $2\gamma(\mathbf{h})$ is called .blue[variogram] and $\gamma(\mathbf{h})$ is called .blue[semivariogram]


- The gamma symbol, $\gamma$, is the standard symbol for variability in a variogram.  Commonly, the terms variogram and semivariogram are used interchangeably, although the semivariogram is half of the variogram (we adopt this common terminology here)


---

# Variogram

- The (semi)variogram is a useful devices in exploratory data analysis for geostatistical data, as it summarizes the strength of association as function of the distance (and in case of anisotropy, direction).


- The variogram analysis is often associated with .blue[kriging], a widely used interpolation method for geostatistical data.


- The variogram is generally estimated by the experimental (or empirical) variogram, $\hat{\gamma}(\mathbf{h})$, which measures the similarity of values as a function of the distance between their locations:

    $$\hat{\gamma}(\mathbf{h})=\frac{1}{2N(\mathbf{h})}\sum_{i}^{N(\mathbf{h})} (Z(\mathbf{s}_i+\mathbf{h})-Z(\mathbf{s}_{i}))^2$$
    

where $\mathbf{h}$ is the distance class and $N(\mathbf{h})$ is the set of pairs of points; therefore the sum is taken over all sample points separated by a lag vector of magnitude $\mathbf{h}$.

---

# Characteristics of the variogram

- .red[Sill]: the value at which the variogram levels off (corresponds to the overall variability of the data)

- .red[Range]: the distance at which the variogram reaches the sill (corresponds to the distance at which observations become independent)

- .red[Nugget]: The nugget represents the combination of sampling error and short-range variability that causes two samples apparently taken from the same location to have different values.

`r include_fig("Semivariogram.jpg",width="37%",title="")`

Note that the partial sill is the sill minus the nugget
---

# Some isotropic variogram functions [1]

- After obtaining the empirical variogram, we fit a model to it (i.e. theoretical variogram) to get a smooth fit. Popular variogram functions are:

`r vspace("20px")`

`r include_fig("Type_Vario.png",width="55%",title="")`

.center[For details, see `r Citet(bibfile,"banerjee2014")`, Sections 2.1.2 - 2.1.4]
---

# Some isotropic variogram functions [2]

- $t^2$ is the nugget

- $t^2 + \sigma^2$ is the sill, therefore $\sigma^2$ is the partial sill

- the value $1/\phi$ is the range, while $\phi$ is called the decay parameter


- For the exponential model, strictly speaking, the range is infinite. In this case the notation of .blue[effective range], $h_0$, is often used.

- It is the distance at which the correlation is negligible, dropping to 0.05. Setting:

\begin{eqnarray*}
\exp(-h_0\phi) &=& 0.05 \\
\Longrightarrow h_0 &=& -\log(0.05)/\phi \\
\Longrightarrow h_0 &\approx& 3/\phi
\end{eqnarray*}

since $\log(0.05)\approx -3$.

---

# Some isotropic variogram functions [3]

Theoretical variograms for three models, respectively linear, spherical, and exponential

`r vspace("20px")`

`r include_fig("Popular_vario.jpg",width="55%",title="")`

.center[Source: `r Citet(bibfile,"banerjee2014")`]

---

# Steps of the variogram analysis

We use here the Meuse data set, which includes four heavy metals measured in the top soil in a flood plain along the river Meuse (it runs from France to the Netherlands)

`r include_fig("Picture_Tom.jpg",width="40%",title="")`
.center[Source: `r Citet(bibfile,"hengl2009")`, https://edepot.wur.nl/485517]

`r vspace("20px")`

- .blue[Steps]: (a) sampling locations and measured values of the target variable, (b)
(semi)variogram cloud showing semivariances for all pairs (log-transformed variable), (c) semivariances aggregated to lags of about 100 m, and (d) the final (semi)variogram model fitted using `gstat`. 
---

# Basic code for the computation of the variogram in `R` [1]
To demonstrate the computation of the variogram in `R`, we use the Meuse data set. Among the metals, we work with zinc

```{r, echo=TRUE, eval=FALSE}
library(sp)
library(gstat)

# We use Meuse dataset, which includes concentrations of zinc
# measured at 155 sampling sites within the Meuse River plain
data(meuse)

# Transform the dataframe into a SpatialPointDataFrame
coordinates(meuse) = ~x+y # the function coordinates
                          # promotes the data.frame meuse
                          # into a SpatialPointsDataFrame

# Bubble plot
bubble(meuse, "zinc", col=c("#00ff0088", "#00ff0088"),
       main = "zinc concentrations (ppm)")

hist(meuse$zinc) # we see a strong right skew in the data, so we log-transform them

# Lagged scatter plot
hscat(log(zinc)~1, meuse,(0:9)*100) # the correlation is quite strong when the lag
                                   # is between 100 meters, then decrease with distance
```

---

# Basic code for the computation of the variogram in `R` [2]
```{r, echo=TRUE, eval=FALSE}
# Construct the variogram
meuse.vgm = variogram(log(zinc)~1, meuse) # we assume a constant trend for
                                           # the variable log(zinc)

# Plot the experimental variogram
plot(meuse.vgm)
plot(meuse.vgm, plot.numbers = TRUE, pch = "+") # The numbers of points in the
                            # lag group used to compute the corresponding value of gamma(h)

# Fit a variogram model
model.1 = fit.variogram(meuse.vgm, vgm("Sph"))
plot(meuse.vgm, model=model.1)

# Look at the result of the fit
model.1

# We can also specify a set of models. In this case the best fitting is returned
model.2 = fit.variogram(meuse.vgm, vgm(c("Exp", "Sph")))
model.2 # here the spherical model with nugget=0.051, partial sill =0.591 and range=897 is chosen

# Specify theoretical variogram with its characteristics
model.final = fit.variogram(meuse.vgm, vgm(psill=0.59,"Sph",range=897,nugget=0.05))
plot(meuse.vgm, model=model.final)

```
---

# References

```{r refs, echo=FALSE, results="asis"}
PrintBibliography(bibfile,.opts=list(max.names=3))
```



